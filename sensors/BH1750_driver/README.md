# BH1750 光强度传感器驱动 - MicroPython版本

## 目录
- [简介](#简介)
- [主要功能](#主要功能)
- [硬件要求](#硬件要求)
- [文件说明](#文件说明)
- [软件设计核心思想](#软件设计核心思想)
- [使用说明](#使用说明)
- [示例程序](#示例程序)
- [注意事项](#注意事项)
- [联系方式](#联系方式)
- [许可协议](#许可协议)

---

## 简介
BH1750是一款数字型光强度传感器，采用I2C通信接口，可测量1-65535 lux的光照强度，适用于智能照明控制、环境光监测、显示屏亮度自动调节等场景。该传感器支持多种测量模式，能在高精度与快速响应之间灵活切换。

本项目提供基于MicroPython的BH1750传感器驱动及测试程序，通过封装底层通信与传感器控制逻辑，为开发者提供简洁易用的接口，快速实现光照强度采集功能，适配树莓派Pico、ESP32等多种MicroPython开发板。

> **注意**：传感器在强光直射环境下可能出现测量饱和，建议在超出测量范围的场景中增加遮光装置。

---

## 主要功能
- 支持多种测量模式切换（高分辨率、低分辨率、单次测量、连续测量）
- 提供光照强度原始值与lux单位转换
- 支持测量精度调节（69%/100%/138%三档）
- 实现迭代器接口，支持循环读取数据
- 适配MicroPython标准I2C接口，跨平台兼容性强

---

## 硬件要求
### 推荐测试硬件
- MicroPython兼容开发板（树莓派Pico/ESP32/ESP8266）
- BH1750光强度传感器模块（支持I2C通信）
- 杜邦线（至少4根）
- USB数据线（用于供电与调试）
- （可选）面包板（便于临时接线测试）

### 模块引脚说明
| BH1750引脚 | 功能描述 | 电气特性 |
|------------|----------|------|
| VCC        | 电源正极 | 3.3V |
| GND        | 电源负极 | 接地 |
| SDA        | I2C数据线 | 双向数据传输，内部集成上拉电阻 |
| SCL        | I2C时钟线 | 单向时钟输入，内部集成上拉电阻 |
| ADDR       | 地址选择引脚 | 接地默认地址0x23，接VCC为0x5C |

---

## 文件说明

- **1. code/bh_1750.py**
- BH1750 光照强度传感器驱动核心类，封装传感器所有操作：
- BH1750 类：提供传感器配置与光照强度测量功能
- init(address, i2c)：初始化传感器，参数包括 I2C 地址和 I2C 实例，默认配置单次测量模式、高分辨率和默认测量时间（69）
- configure (measurement_mode, resolution, measurement_time)：配置测量模式（连续 / 单次）、分辨率（高 / 高 2 / 低）和测量时间（31-254），超出范围抛出异常
- reset ()：重置传感器，清除光照数据寄存器
- power_on ()/power_off ()：控制传感器电源开关
- measurement：属性方法，获取当前光照强度（lux），单次模式下会触发测量，自动根据分辨率和测量时间计算结果
- measurements ()：生成器方法，持续返回光照强度，根据分辨率和测量时间自动计算睡眠时间
- 内部方法：_write_measurement_time () 写入测量时间到寄存器，_write_measurement_mode () 写入测量模式和分辨率并添加对应延迟
- 常量定义：测量模式（连续 / 单次）、分辨率（高 / 高 2 / 低）、测量时间范围（31-254，默认 69）

- **2. code/main.py**
- BH1750 传感器测试主程序，验证传感器各模式功能：
- 初始化配置：创建 I2C 总线（指定 scl=Pin (1)、sda=Pin (0)），扫描 I2C 总线上的设备并识别 BH1750 地址（0x60-0x70 范围）
- **测试流程**：
- 单次测量模式：配置为单次测量、高分辨率、测量时间 69，循环 5 次读取并打印光照强度，间隔 1 秒
- 连续测量模式：重新配置为连续测量模式，循环 5 次读取并打印光照强度，间隔 1 秒
- 生成器模式：通过 measurements () 生成器循环 5 次获取并打印光照强度
- 包含延迟操作（初始化延迟 3 秒、模式切换延迟 2 秒），确保传感器稳定工作
---

## 软件设计核心思想
### 分层设计
- 中层实现：bh1750.py专注于传感器特性，实现具体控制逻辑
- 高层应用：main.py演示实际使用场景，提供完整测试流程

### 接口标准化
- 支持for循环迭代读取数据
- 通过属性封装模式配置，简化参数设置流程

### 兼容性设计
- 采用MicroPython标准I2C接口，不依赖硬件特定库
- 支持两种I2C地址（0x23/0x5C），适配不同接线方式
- 兼容3.3V/5V电源电压，适应多种开发板供电场景

### 可靠性保障
- 测量前检查传感器电源状态，确保数据有效性
- 内置测量转换时间计算，避免读取未就绪数据
- 提供软复位功能，异常时可恢复传感器正常工作状态

---

## 使用说明
### 硬件接线（树莓派Pico示例）
| BH1750引脚 | 树莓派Pico引脚 | 备注 |
|------------|----------------|------|
| VCC        | 3.3V（物理引脚36） | 也可接5V引脚（模块支持宽电压） |
| GND        | GND（物理引脚38） | 必须共地 |
| SDA        | GP4（物理引脚6） | I2C数据引脚，可修改为其他I2C引脚 |
| SCL        | GP5（物理引脚7） | I2C时钟引脚，可修改为其他I2C引脚 |
| ADDR       | GND | 选择默认地址0x23，接VCC时地址为0x5C |

> **注意**：
> - 若ADDR引脚悬空，默认地址为0x23，但可能受干扰导致地址不稳定
> - 无需额外上拉电阻（模块内部已集成）
> - 接线时避免SDA/SCL与高功率设备共用导线，减少干扰

### 软件依赖
- **固件版本**：MicroPython v1.23.0及以上
- **内置库**：
  - machine：提供I2C与Pin控制接口
  - time：用于测量延时与转换等待
- **开发工具**：Thonny、PyCharm（带MicroPython插件）

### 安装步骤
1. 使用Thonny烧录代码驱动和测试文件，点击绿色三角按钮实现运行或者使用REPL
---

## 示例程序
```python
# Python env   : MicroPython v1.23.0
# -*- coding: utf-8 -*-
# @Time    : 2025/9/23 下午4:18
# @Author  : 缪贵成
# @File    : main.py
# @Description : BH1750光照强度传感器测试文件

# ======================================== 导入相关模块 =========================================

from machine import I2C, Pin
import time
from bh_1750 import BH1750

# ======================================== 全局变量 ============================================

BH_addr = None

# ======================================== 功能函数 ============================================

# ======================================== 自定义类 ============================================

# ======================================== 初始化配置 ===========================================

time.sleep(3)
print("FreakStudio: test Light Intensity Sensor now")
# Create I2C bus (adjust pins according to your board)
i2c = I2C(0, scl=Pin(1), sda=Pin(0), freq=100000)
# 开始扫描I2C总线上的设备，返回从机地址的列表
devices_list: list[int] = i2c.scan()
print('START I2C SCANNER')
# 若devices list为空，则没有设备连接到I2C总线上
if len(devices_list) == 0:
    # 若非空，则打印从机设备地址
    print("No i2c device !")
else:
    # 遍历从机设备地址列表
    print('i2c devices found:', len(devices_list))
for device in devices_list:
    # 判断设备地址是否为的BH_1750地址
    if 0x21 <= device <= 0x5E:
        # 假设第一个找到的设备是BH_1750地址
        print("I2c hexadecimal address:", hex(device))
        BH_addr = device
sensor = BH1750(BH_addr, i2c)

# ========================================  主程序  ============================================

print("one time measure")
sensor.configure(
    measurement_mode=BH1750.MEASUREMENT_MODE_ONE_TIME,
    resolution=BH1750.RESOLUTION_HIGH,
    measurement_time=69
)
for i in range(5):
    lux = sensor.measurement
    print("One-time lux =", lux)
    time.sleep(1)

time.sleep(2)

# --- Continuous measurement test ---
print("\n>>> Continuous measurement mode <<<")
sensor.configure(
    measurement_mode=BH1750.MEASUREMENT_MODE_CONTINUOUSLY,
    resolution=BH1750.RESOLUTION_HIGH,
    measurement_time=69
)
for i in range(5):
    lux = sensor.measurement
    print("Continuous lux =", lux)
    time.sleep(1)

time.sleep(2)

# --- Generator test ---
print("\n>>> Generator mode <<<")
gen = sensor.measurements()
for i in range(5):
    lux = next(gen)
    print("Generator lux =", lux)

print("\nTest finished.")


```
---

## 注意事项
### 1. 通信问题
- I2C地址冲突：若总线上有其他设备使用0x23或0x5C地址，需通过ADDR引脚修改传感器地址,接地表示0x23,vcc表示0x5C
- 通信失败：检查接线是否牢固、I2C频率是否过高（建议100kHz），可尝试降低通信频率
- 数据异常：连续读取失败时，可调用soft_reset()重置传感器后重试

### 2. 测量精度
- 模式选择：高精度模式（1lx分辨率）适合静态环境，快速模式适合动态场景
- 精度调节：138%精度模式适合弱光环境，69%精度模式适合强光环境
- 环境影响：传感器对红外光敏感，避免在红外光源直射下使用

### 3. 电源管理
- 低功耗设计：无需测量时调用power(False)关闭电源，降低功耗
- 启动时间：从关闭到开启状态需等待至少10ms才能进行测量
- 电压稳定性：电源波动会影响测量精度，建议使用稳压电源或添加滤波电容

### 4. 软件使用
- 迭代器使用：通过for循环迭代读取时，需确保传感器处于连续测量模式
- 模式切换：修改测量模式后，需等待至少10ms再进行测量
- 数据范围：超过65535lux时返回最大值，需通过外部手段判断是否过饱和

---
## 联系方式
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com  
💻 **GitHub**：https://github.com/FreakStudioCN

---
## 许可协议
本项目中，除 `machine` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (CC BY-NC 4.0)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。您可以用任何合理的方式来署名，但是不得以任何方式暗示许可人为您或您的使用背书。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。  
- **说明** — 代码含参考部分,出现非技术问题和署名作者无关。  
**版权归 FreakStudio 所有。**