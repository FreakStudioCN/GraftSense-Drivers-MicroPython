# 火焰传感器驱动 - MicroPython版本

## 目录
- [简介](#简介)
- [主要功能](#主要功能)
- [硬件要求](#硬件要求)
- [文件说明](#文件说明)
- [软件设计核心思想](#软件设计核心思想)
- [使用说明](#使用说明)
- [示例程序](#示例程序)
- [注意事项](#注意事项)
- [联系方式](#联系方式)
- [许可协议](#许可协议)

---

## 简介
火焰传感器是一种能够检测火焰（或高强度红外光）的专用传感器，通过 AO 模拟引脚输出与火焰强度相关的电压信号，DO 数字引脚输出高低电平触发信号。该传感器具有响应速度快、检测灵敏度高、抗干扰能力强等特点，广泛应用于火灾报警系统、工业安全监测、智能消防设备、机器人避火等场景。

本项目提供了基于 MicroPython 的驱动代码及示例程序，支持火焰数字触发检测、模拟电压读取、中断回调等功能，方便开发者快速集成火焰传感器。

> **注意**：该传感器主要用于火焰存在性检测，不适合精确测量火焰温度、大小等参数；在火灾预警等安全场景中，需配合多重验证机制，避免单一传感器误触发导致误报警。

---

## 主要功能
- **双模式检测**：
  - 数字模式（DO）：通过高低电平快速判断是否检测到火焰（触发式）
  - 模拟模式（AO）：读取模拟电压值，反映火焰强度变化（量化式）
- **灵活的事件响应**：
  - 中断触发：支持 GPIO 中断检测，火焰触发时自动执行回调函数
  - 阻塞等待：提供 `wait_for_flame()` 方法，支持超时的阻塞式火焰检测
- **数据转换与查询**：
  - 读取 AO 原始 ADC 值
  - 自动将 ADC 值转换为实际电压（单位：V）
  - 提供引脚对象访问接口，支持底层硬件控制
- **资源管理**：支持启用/禁用中断，避免不必要的资源占用
- **跨平台兼容**：仅依赖 MicroPython 标准库，兼容树莓派 Pico 等主流开发板

---

## 硬件要求
### 推荐测试硬件
- 树莓派 Pico/Pico W
- 火焰传感器模块（如 IR Flame Sensor 等，需支持 AO/DO 双输出）
- 杜邦线若干
- （可选）3.3V 电源模块（若开发板供电不稳定）

### 模块引脚说明
| 火焰传感器引脚 | 功能描述 | 电压要求 | 连接说明                         |
|----------------|----------|----------|------------------------------|
| VCC            | 电源正极 | 3.3V（部分模块支持 5V，需参考型号） | 连接开发板 3.3V 引脚                |
| GND            | 电源负极 | 接地 | 连接开发板 GND 引脚                 |
| AO             | 模拟输出引脚 | 0V - 3.3V（随火焰强度变化） | 连接开发板 ADC 引脚（如 Pico 的 GP26）  |
| DO             | 数字输出引脚 | 高电平（无火焰）/低电平（有火焰） | 连接开发板 GPIO 引脚（如 Pico 的 GP19） |

> **说明**：不同型号传感器的 DO 触发逻辑可能不同（部分为“有火焰输出高电平”），需实际测试确认，或通过模块电位器调整触发阈值。

---

## 文件说明
### flame_sensor.py
实现火焰传感器的核心驱动逻辑，核心类 `FlameSensor` 封装所有功能接口，支持 AO/DO 双引脚控制与事件响应。

#### 类定义：`FlameSensor`
- **`__init__(analog_pin: int, digital_pin: int, callback: callable = None) -> None`**  
  初始化火焰传感器：传入 AO 引脚编号（用于 ADC 读取）、DO 引脚编号（用于数字触发），可选绑定火焰触发回调函数；初始化 ADC 对象、GPIO 输入引脚及中断相关变量。
- **`is_flame_detected() -> bool`**  
  读取 DO 引脚状态：返回 `True` 表示检测到火焰，`False` 表示未检测到（具体逻辑需匹配传感器 DO 输出特性）。
- **`get_analog_value() -> int`**  
  读取 AO 引脚原始 ADC 值：返回范围为 0~65535（取决于 MicroPython ADC 分辨率），值越大通常表示火焰强度越高或距离越近。
- **`get_voltage() -> float`**  
  将 AO 原始值转换为实际电压：基于 3.3V 参考电压计算，公式为 `ADC值 / 65535 * 3.3`，返回单位为伏特（V）。
- **`set_callback(callback: callable) -> None`**  
  设置火焰触发回调函数：回调函数将在 DO 引脚触发中断时，通过 `micropython.schedule` 在主线程安全执行。
- **`_irq_handler(pin: Pin) -> None`**  
  内部中断处理函数：仅更新火焰检测状态和事件标志，避免在中断上下文（ISR）中执行耗时操作；自动调度用户回调。
- **`_scheduled_callback(arg: int) -> None`**  
  内部调度函数：由 `micropython.schedule` 调用，在主线程中执行用户绑定的回调函数，确保操作安全（如打印、LED 控制等）。
- **`enable() -> None`**  
  启用 DO 引脚中断：配置 GPIO 中断触发类型（默认下降沿，匹配“有火焰时 DO 输出低电平”的逻辑），绑定中断处理函数。
- **`disable() -> None`**  
  禁用 DO 引脚中断：清除中断处理函数，释放中断资源，避免不必要的触发。
- **`wait_for_flame(timeout: int = None) -> bool`**  
  阻塞等待火焰触发：无超时则无限等待，有超时则超过指定秒数后返回 `False`；检测到火焰时返回 `True`，适合简单的同步检测场景。
- **`digital (property) -> Pin`**  
  属性方法：返回 DO 引脚的 `Pin` 对象，支持底层硬件配置（如修改引脚模式）。
- **`analog (property) -> ADC`**  
  属性方法：返回 AO 引脚的 `ADC` 对象，支持自定义 ADC 配置（如分辨率调整）。

### main.py
火焰传感器功能测试程序，演示传感器初始化、中断回调绑定、模拟电压读取、中断启用/禁用等完整流程。

---

## 软件设计核心思想
### 模块化与分层设计
- 将“硬件控制”（ADC 读取、GPIO 中断）与“业务逻辑”（火焰判断、回调执行）分离，封装为独立方法
- 通过统一类接口对外提供服务，隐藏底层硬件细节（如 ADC 分辨率、中断触发类型），降低开发难度

### 中断安全机制
- **中断上下文保护**：中断处理函数（`_irq_handler`）仅执行状态更新和回调调度，不进行打印、延时等耗时操作，避免阻塞系统
- **主线程回调**：使用 `micropython.schedule` 将用户回调调度到主线程执行，确保回调中可安全操作硬件、打印信息

### 双模式数据互补
- 数字模式（DO）：适合快速触发场景，响应速度快、资源占用低，用于火灾报警等紧急事件
- 模拟模式（AO）：适合量化火焰强度场景，可通过电压变化判断火焰距离或大小，用于火情程度评估
- 两种模式可同时工作，满足不同场景需求

### 灵活性与可扩展性
- 支持动态绑定/修改回调函数（`set_callback`），无需重新初始化传感器
- 提供引脚对象访问接口（`digital`/`analog` 属性），允许开发者根据需求自定义硬件配置
- 中断启用/禁用独立控制，可在不需要检测时关闭中断，降低系统功耗

---

## 使用说明
### 硬件接线（树莓派 Pico 示例）
| 火焰传感器引脚 | Pico GPIO 引脚 | 接线功能 |
|----------------|--------------|----------|
| VCC            | 3.3V（Pin36）  | 传感器电源输入 |
| GND            | GND（Pin38）   | 电源接地 |
| AO             | GP26（Pin31）  | 模拟信号输入（ADC0） |
| DO             | GP19         | 数字信号输入（中断触发） |

> **注意**：
> 1. 确认传感器供电电压，若模块支持 5V 供电，需调整 VCC 连接（如 Pico 的 5V 引脚），避免烧毁传感器或开发板
> 2. 若 DO 引脚触发逻辑与默认相反（有火焰输出高电平），需修改 `enable()` 方法中的中断触发类型为 `Pin.IRQ_RISING`

---

### 软件依赖
- **固件版本**：MicroPython v1.23+  
- **内置库**：
  - `machine`：用于 GPIO 控制、ADC 读取、中断配置
  - `time`：用于延时、超时计算
  - `micropython`：用于安全调度回调函数
- **开发工具**：Thonny、PyCharm（带 MicroPython 插件）

---

### 安装步骤
1. **烧录固件**：将 MicroPython v1.23+ 固件烧录到树莓派 Pico
2. **上传文件**：将 `flame_sensor.py` 和 `main.py` 上传到 Pico 的文件系统
3. **配置引脚**：根据硬件接线修改 `main.py` 中 `FlameSensor` 初始化的 `analog_pin` 和 `digital_pin` 编号（默认 AO=26、DO=15）
4. **运行测试**：在开发工具中执行 `main.py`，将火焰（如打火机火焰）靠近传感器，观察打印信息

---

## 示例程序
```python
# MicroPython v1.23.0
# -*- coding: utf-8 -*-   
# @Time    : 2025/8/23 下午5:55
# @Author  : 缪贵成
# @File    : main.py
# @Description : 火器驱焰传感动测试文件
# @License : CC BY-NC 4.0

__version__ = "0.1.0"  # 语义化版本规范：主版本.次版本.修订号
__author__ = "缪贵成"
__license__ = "CC BY-NC 4.0"
__platform__ = "MicroPython v1.23"
# ======================================== 导入相关模块 =========================================

import time
from machine import Pin
from flame_sensor import FlameSensor
# ======================================== 全局变量 =============================================

# ======================================== 功能函数 =============================================


def flame_detected_callback() -> None:
    """
    火焰检测回调函数。当数字引脚 DO 触发时，由 micropython.schedule 调用。

    Notes:
        回调在主线程中执行，可以安全进行打印或 LED 控制。

    ==========================================

    Callback function triggered on flame detection.
    Called by micropython.schedule when digital pin DO triggers.

    Notes:
        Safe to perform printing or LED control in main thread.
    """
    print("Flame detected!")

# ======================================== 自定义类 =============================================
# ======================================== 初始化配置 ===========================================


print("FreakStudio:  Flame Sensor Test Starting in 3 seconds")
time.sleep(3)
# 初始化火焰传感器对象，假设 AO 引脚为 26，DO 引脚为 19
flame_sensor = FlameSensor(analog_pin=26, digital_pin=19, callback=flame_detected_callback)
# 启用数字引脚中断
flame_sensor.enable()
# ======================================== 主程序 ==============================================


def main():
    """
    测试火焰传感器功能：
        延时 3 秒打印测试开始信息
        初始化 FlameSensor 对象
        设置中断回调
        启用数字中断
        循环打印 AO 模拟电压值

    Notes:
        主循环不轮询 DO 状态，只依赖中断回调处理火焰事件。

    ==========================================

    Test flame sensor functionality:
        Wait 3 seconds and print test start message
        Initialize FlameSensor object
        Set interrupt callback
        Enable digital pin IRQ
        Loop and print AO analog voltage

    Notes:
        Main loop does not poll DO; flame events are handled via callback.
    """
    print("=== Flame Sensor Initialized. Monitoring AO voltage... ===")

    try:
        while True:
            # 获取 AO 模拟值并转换为电压
            voltage = flame_sensor.get_voltage()
            print("AO Voltage: {:.2f} V".format(voltage))
            time.sleep(1)
    except KeyboardInterrupt:
        print("=== Test Stopped by User ===")
        flame_sensor.disable()


if __name__ == "__main__":
    main()

```
---
## 注意事项

### 传感器特性限制
- **检测范围**：有效检测距离通常为 0.1m~1.5m（随火焰强度变化），超过范围可能无法检测
- **光谱依赖性**：主要检测火焰中的红外光，对无红外辐射的冷光源（如 LED 灯）无响应，但可能受阳光、白炽灯等强红外光源干扰
- **触发阈值**：DO 引脚触发阈值可通过模块电位器调整，需根据实际场景校准（如避免环境光误触发）

---

### 硬件接线与配置注意事项
- **电压匹配**：严格按照传感器规格选择供电电压（优先 3.3V，避免 5V 直接接入 3.3V 传感器），接反 VCC/GND 会直接烧毁模块
- **AO 引脚选择**：必须连接开发板的 ADC 引脚（如 Pico 的 GP26~GP28），普通 GPIO 引脚无法读取模拟信号
- **抗干扰布线**：AO 引脚接线尽量短，远离电机、继电器等强电磁干扰源，避免模拟信号失真；必要时可增加屏蔽线
- **阈值校准**：首次使用前，需在无火焰环境下调整模块电位器，确保 DO 输出高电平；再用火焰测试，确认 DO 能触发低电平（或相反逻辑）

---

### 软件使用建议
- **中断触发类型调整**：若传感器 DO 引脚 “有火焰输出高电平”，需修改 enable() 方法中 irq 的 trigger 参数为 Pin.IRQ_RISING
- **回调函数设计**：回调函数需简短（避免循环、延时），复杂逻辑（如控制继电器、发送报警信息）建议在回调中设置标志，主线程处理
- **模拟值滤波**：若 AO 电压值波动较大，可增加多次读取取平均值的逻辑（如连续读取 5 次，去掉最大值和最小值后求平均）
- **资源释放**：程序退出或长时间不使用传感器时，务必调用 disable() 方法禁用中断，避免中断残留导致系统异常

---

### 环境影响
- **温度限制**：避免在高温环境（>50℃）使用，否则传感器自身温度升高可能导致灵敏度下降或误触发
- **湿度限制**：传感器内部为电子元件，高湿环境（>85% RH）可能导致引脚腐蚀或短路，建议在干燥环境使用或增加防水措施
- **光线干扰**：避免在阳光直射或强红外光源（如浴霸、高温烤箱）附近使用，必要时增加遮光罩过滤环境光

## 联系方式
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com  
💻 **GitHub**：[https://github.com/FreakStudioCN](https://github.com/FreakStudioCN)  

---

## 许可协议
本项目中，除 `machine`、`time` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (CC BY-NC 4.0)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。您可以用任何合理的方式来署名，但是不得以任何方式暗示许可人为您或您的使用背书。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。  

**版权归 FreakStudio 所有。**