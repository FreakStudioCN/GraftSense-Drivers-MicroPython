# TCR5000L 单路循迹模块驱动 - MicroPython版本

## 目录
- [简介](#简介)
- [主要功能](#主要功能)
- [硬件要求](#硬件要求)
- [文件说明](#文件说明)
- [软件设计核心思想](#软件设计核心思想)
- [使用说明](#使用说明)
- [示例程序](#示例程序)
- [注意事项](#注意事项)
- [联系方式](#联系方式)
- [许可协议](#许可协议)

---

## 简介
基于TCR5000L芯片的单路循迹模块是一款光电反射式传感器，通过检测物体表面反射光强度来识别黑白边界，广泛应用于机器人循迹、线路检测、物体识别等场景。

本项目提供了基于 MicroPython 的驱动代码及示例程序，方便开发者快速接入 TCR5000L 模块，实现线路跟踪功能。

---

## 主要功能
- **基础电平读取**：提供数字信号读取接口，直接获取传感器检测状态
- **中断触发机制**：支持上升沿、下降沿及双边沿中断触发
- **回调函数支持**：通过中断回调机制实时响应电平变化
- **资源管理**：提供完善的初始化与资源释放接口
- **跨平台支持**：兼容多种硬件平台（树莓派Pico等MicroPython兼容开发板）

---

## 硬件要求
### 推荐测试硬件
- 树莓派 Pico/Pico W
- TCR5000L 单路循迹模块
- 杜邦线若干

### 模块引脚说明
| TCR5000L 引脚 | 功能描述 |
|--------------|----------|
| VCC          | 电源正极（3.3V-5V） |
| GND          | 电源负极 |
| OUT          | 数字信号输出引脚 |

---

## 文件说明

### tcr5000.py
- TCR5000类：控制TCR5000L光电反射式循迹传感器，提供电平读取和中断回调功能
  - __init__方法：初始化传感器引脚并配置中断触发模式，参数为传感器信号脚连接的GPIO引脚编号和中断触发方式（默认为下降沿和上升沿）
  - read方法：读取当前电平，返回值为int类型的0或1
  - set_callback方法：注册用户回调函数，在电平变化时调度执行，参数为用户函数（签名为func(value: int)）
  - _irq_handler方法：内部中断处理函数，用于捕获传感器电平变化并调度回调执行，参数为触发中断的引脚对象
  - _scheduled_callback方法：在调度上下文中执行用户注册的回调函数，参数为当前引脚电平（0或1）
  - deinit方法：注销中断并释放资源

### main.py
- on_change函数：TCR5000电平变化回调函数，在传感器电平变化时触发，参数为当前电平（0=黑线，1=白底）

---

## 软件设计核心思想
### 模块化设计
- 将传感器控制逻辑封装在独立类中
- 分离硬件操作与业务逻辑，提高代码复用性
- 提供清晰的初始化与资源释放接口

### 中断处理机制
- 使用硬件中断实现实时响应
- 通过 micropython.schedule 将回调函数调度到主循环执行，避免在中断服务程序（ISR）中执行耗时操作
- 支持灵活配置中断触发方式（上升沿、下降沿或双边沿）

### 跨平台兼容
- 仅依赖 MicroPython 标准库，减少硬件耦合
- 通过 GPIO 抽象层屏蔽不同硬件平台的差异

### 资源管理
- 提供 deinit() 方法释放硬件资源，避免资源泄漏
- 完善的错误处理机制，确保系统稳定性

---

## 使用说明

### 硬件接线（树莓派 Pico 示例）

| TCR5000L 引脚 | Pico GPIO 引脚 |
|---------------|----------------|
| VCC           | 3.3V 或 5V     |
| GND           | GND            |
| OUT           | GP14           |

> **注意：**
> - 确保 VCC 和 GND 接线正确
> - OUT 引脚为数字信号输出，连接到任意 GPIO 输入引脚

---

### 软件依赖

- **固件版本**：MicroPython v1.23+  
- **内置库**：
  - machine（用于 GPIO 控制）
  - time（用于延时）
  - micropython（用于回调调度）
- **开发工具**：PyCharm 或 Thonny（推荐）

---

### 安装步骤

1. 将 MicroPython 固件烧录到树莓派 Pico  
2. 上传 tcr5000.py 和 main.py 到 Pico  
3. 根据硬件连接修改 main.py 中的引脚配置  
4. 在开发工具中运行 main.py，开始测试

---
## 示例程序
```python
# MicroPython v1.23.0
# -*- coding: utf-8 -*-   
# @Time    : 2025/9/4 上午9:44
# @Author  : 缪贵成
# @File    : main.py
# @Description : 单路循迹模块驱动测试文件

# ======================================== 导入相关模块 =========================================

import time
from tcr5000 import TCR5000

# ======================================== 全局变量 ============================================

# ======================================== 功能函数 ============================================

def on_change(value: int) -> None:
    """
    TCR5000 电平变化回调函数，在传感器电平变化时触发。

    Args:
        value (int): 当前电平，0=黑线，1=白底。

    Notes:
        回调通过 micropython.schedule 调度到主循环执行，避免在 ISR 中执行耗时操作。
        用户可以在回调中处理传感器状态变化，例如打印或控制马达。

    ==========================================

    TCR5000 level change callback, triggered on sensor level change.

    Args:
        value (int): Current pin value, 0=black line, 1=white background.

    Notes:
        Callback is scheduled via micropython.schedule to main loop context, avoiding ISR execution.
        User can handle sensor state changes here, e.g., print or motor control.
    """
    print("Callback triggered, value =", value)

# ======================================== 自定义类 ============================================

# ======================================== 初始化配置 ==========================================

time.sleep(3)
print("FreakStudio:Single-channel tracking module test")
# 初始化 TCR5000 传感器
sensor = TCR5000(pin=14)
# 注册回调函数
sensor.set_callback(on_change)

# ========================================  主程序  ===========================================

try:
    while True:
        val = sensor.read()
        print("Current value:", val)
        time.sleep(1)

except KeyboardInterrupt:
    sensor.deinit()
    print("Program interrupted, resources released.")
```
---
## 注意事项

### 电平含义
- 通常情况下：
  - 检测到黑线时输出 0
  - 检测到白底时输出 1
- 具体定义可能因模块硬件设计略有差异，建议通过测试确认

---

### 电源要求
- 供电电压：3.3V-5V
- 确保电源稳定，避免电压波动影响检测精度

---

### 安装调试
- 安装时应保证传感器与检测面平行
- 适当调整传感器高度（通常5-15mm）以获得最佳检测效果
- 可通过模块上的电位器调节检测灵敏度

---

### 中断回调注意事项
- 回调函数应尽量简短，避免耗时操作
- 不要在回调函数中使用 print() 等可能阻塞的操作（除非通过 micropython.schedule 调度）
- 多次触发中断时，回调函数会按顺序执行

---

### 环境因素
- 强光环境可能影响检测精度，必要时增加遮光罩
- 检测面反光率差异越大，检测效果越好

---

## 联系方式
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com  
💻 **GitHub**：https://github.com/FreakStudioCN

---

## 许可协议
本项目中，除 machine 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (CC BY-NC 4.0)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。 
- **说明** — 代码含参考部分,出现非技术问题和署名作者无关。  
**版权归 FreakStudio 所有。**
