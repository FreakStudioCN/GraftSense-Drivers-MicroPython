# 滚珠震动传感器驱动 - MicroPython版本

## 目录
- [简介](#简介)
- [主要功能](#主要功能)
- [硬件要求](#硬件要求)
- [文件说明](#文件说明)
- [软件设计核心思想](#软件设计核心思想)
- [使用说明](#使用说明)
- [示例程序](#示例程序)
- [注意事项](#注意事项)
- [联系方式](#联系方式)
- [许可协议](#许可协议)

---

## 简介
滚珠震动传感器是一种基于机械滚珠结构的触发式传感器，通过震动导致滚珠接触/分离实现电路通断，进而输出数字信号。该传感器具有成本低、响应灵敏、结构耐用等特点，广泛应用于设备震动监测、安防报警、智能玩具互动、工业设备状态检测等场景。

> **注意**：不适用于高精度震动频率/幅度测量，仅支持震动有无的定性检测。

本项目提供了基于 MicroPython 的驱动代码及示例程序，支持震动检测、中断回调、消抖处理等功能，方便开发者快速集成滚珠震动传感器。

---

## 主要功能
- **双模式震动检测**：
  - 轮询模式：通过 `read()` 方法主动读取当前震动状态
  - 中断模式：通过 GPIO 中断触发回调，低功耗高效检测
- **消抖处理**：可配置消抖时间（默认50ms），避免机械抖动导致误触发
- **回调机制**：支持绑定自定义回调函数，震动触发时自动执行
- **状态查询**：通过 `get_status()` 获取传感器当前状态（上次状态、消抖时间、回调绑定情况）
- **资源管理**：提供 `init()`/`deinit()` 方法，支持传感器初始化与资源释放
- **跨平台兼容**：仅依赖 MicroPython 标准库，兼容树莓派 Pico 等主流开发板

---

## 硬件要求
### 推荐测试硬件
- 树莓派 Pico/Pico W
- 滚珠震动传感器模块（如 SW-420 等）
- 杜邦线若干
- （可选）3.3V/5V 电源模块（若开发板供电不足）

### 模块引脚说明
| 滚珠震动传感器引脚 | 功能描述 | 电压要求 |
|--------------------|----------|----------|
| VCC                | 电源正极 | 3.3V - 5V（具体参考传感器型号） |
| GND                | 电源负极 | 接地 |
| OUT                | 信号输出引脚 | 高电平（震动触发）/低电平（无震动） |

---

## 文件说明
### vibration_sensor.py
实现滚珠震动传感器的核心驱动逻辑，核心类 `VibrationSensor` 封装所有功能接口。

#### 类定义：`VibrationSensor`
- **`__init__(pin: Pin, callback: callable = None, debounce_ms: int = 50) -> None`**  
  初始化传感器：绑定 GPIO 引脚对象、设置可选回调函数、配置消抖时间（默认50ms），初始化状态变量（上次触发时间、上次状态）。
- **`init(self) -> None`**  
  初始化模块：将引脚配置为输入模式，若已设置回调函数则启用 GPIO 中断（上升沿+下降沿触发）。
- **`deinit(self) -> None`**  
  释放资源：禁用 GPIO 中断，清除中断对象引用，避免资源泄漏。
- **`read(self) -> bool`**  
  读取当前震动状态：返回 `True` 表示检测到震动，`False` 表示无震动，同步更新 `_last_state` 变量。
- **`_irq_handler(self, pin: Pin) -> None`**  
  内部中断处理函数：带消抖逻辑（触发间隔需超过 `debounce_ms`），更新传感器状态，调度用户回调。
- **`_scheduled_callback(self, arg: int) -> None`**  
  内部调度函数：通过 `micropython.schedule` 在主线程安全执行用户回调，避免中断内耗时操作。
- **`get_status(self) -> dict`**  
  返回传感器状态字典：包含 `last_state`（上次检测状态）、`debounce_ms`（当前消抖时间）、`callback_set`（是否绑定回调）。

### main.py
滚珠震动传感器功能测试程序，演示传感器初始化、中断回调、状态轮询、状态查询等完整流程。

---

## 软件设计核心思想
### 模块化与封装
- 将震动检测、中断控制、消抖处理等逻辑封装为独立方法，通过统一类接口对外提供服务
- 隐藏底层硬件操作细节（如 GPIO 中断配置、消抖计时），降低开发难度

### 中断与消抖优化
- **中断触发**：采用 GPIO 上升沿+下降沿双触发，确保震动开始/结束均能被检测
- **消抖机制**：通过 `_last_trigger` 记录上次有效触发时间，过滤短于 `debounce_ms` 的抖动信号
- **安全回调**：使用 `micropython.schedule` 调度回调，避免中断上下文执行复杂逻辑导致系统异常

### 状态管理
- 维护 `_last_state` 变量记录传感器最新状态，支持轮询与中断模式下的状态同步
- 提供 `get_status()` 方法，方便开发者实时查询传感器配置与运行状态

### 跨平台兼容
- 仅依赖 MicroPython 标准库（`machine`、`time`、`micropython`），不绑定特定硬件平台
- 引脚初始化由应用层传入 `Pin` 对象，驱动层不负责硬件配置，提升复用性

---

## 使用说明
### 硬件接线（树莓派 Pico 示例）
| 滚珠震动传感器引脚 | Pico GPIO 引脚 | 接线说明 |
|--------------------|--------------|----------|
| VCC                | 3.3V（Pin36）  | 传感器电源输入 |
| GND                | GND（Pin38）   | 电源接地 |
| OUT                | GP6          | 信号输出到开发板 |

> **注意**：
> 1. 确认传感器供电电压，避免 5V 传感器接 3.3V 导致灵敏度不足，或 3.3V 传感器接 5V 烧毁模块
> 2. 若使用其他开发板，需对应调整 GPIO 引脚编号

---

### 软件依赖
- **固件版本**：MicroPython v1.23+  
- **内置库**：
  - `machine`：用于 GPIO 引脚控制、中断配置
  - `time`：用于延时、时间差计算（消抖）
  - `micropython`：用于安全调度回调函数
- **开发工具**：Thonny、PyCharm（带 MicroPython 插件）

---

### 安装步骤
1. **烧录固件**：将 MicroPython v1.23+ 固件烧录到树莓派 Pico
2. **上传文件**：将 `vibration_sensor.py` 和 `main.py` 上传到 Pico 的文件系统
3. **配置引脚**：根据硬件接线修改 `main.py` 中 `Pin(15)` 的引脚编号（对应传感器 OUT 引脚）
4. **运行测试**：在开发工具中执行 `main.py`，开始震动检测测试

---

## 示例程序
```python
# MicroPython v1.23.0
# -*- coding: utf-8 -*-   
# @Time    : 2025/8/23 下午4:08
# @Author  : 缪贵成
# @File    : main.py
# @Description : 滚珠震动传感器驱动测试文件

# ======================================== 导入相关模块 ==========================================

import time
from machine import Pin
from vibration_sensor import VibrationSensor

# ======================================== 全局变量 =============================================

# ======================================== 功能函数 ==============================================

def vibration_callback() -> None:
    """
    震动回调函数，在检测到震动时触发。

    Notes：
        该函数由中断触发，通过 micropython.schedule 调度执行。
    ==========================================
    Vibration callback function, triggered when vibration is detected.

    Notes:
        This function is called from interrupt, scheduled via micropython.schedule.
    """
    print("Vibration detected callback triggered!")

# ======================================== 自定义类 =============================================

# ======================================== 初始化配置 ============================================

# 上电延时，确保硬件稳定
time.sleep(3)
print("FreakStudio: Vibration Sensor Test Start")
# 初始化震动传感器，GPIO 引脚 15 输入，回调函数处理
sensor = VibrationSensor(pin=Pin(1), callback=vibration_callback, debounce_ms=10)
sensor.init()
print("Sensor initialized with callback and debounce 50ms.")

# ======================================== 主程序 ===============================================

try:
    start_time = time.ticks_ms()
    while True:
        # 轮询读取传感器状态
        current_state: bool = sensor.read()
        print(f"Current vibration state: {current_state}")

        # 每隔 2 秒打印状态字典
        if time.ticks_diff(time.ticks_ms(), start_time) > 2000:
            status: dict = sensor.get_status()
            print(f"Sensor status: {status}")
            start_time = time.ticks_ms()

        time.sleep(0.2)

except KeyboardInterrupt:
    # 用户中断退出
    print("KeyboardInterrupt detected. Exiting test...")

finally:
    # 安全释放资源
    sensor.deinit()
    print("Sensor deinitialized. Test completed.")

```
---
## 注意事项

### 传感器特性限制
- **检测范围**：仅支持定性检测（震动有无），无法测量震动频率、幅度等参数
- **触发阈值**：不同型号传感器触发灵敏度不同，剧烈震动才会触发（轻微震动可能无响应）
- **恢复时间**：震动结束后，需等待滚珠复位（约 10-50ms）才能再次检测

---

### 硬件接线注意事项
- **电压匹配**：严格按照传感器规格选择供电电压（3.3V/5V），避免接反 VCC/GND 烧毁模块
- **布线规范**：传感器 OUT 引脚接线尽量短，远离强干扰源（如电机、继电器），避免信号干扰
- **供电稳定**：若多个传感器同时工作，建议使用外部电源模块，避免开发板供电不足导致误触发

---

### 软件配置建议
- **消抖时间调整**：
  - 若环境震动频繁（如电机附近），可增大 `debounce_ms`（如 100ms）减少误触发
  - 若需检测快速震动，可减小 `debounce_ms`（如 20ms），但需避免抖动误触发
- **回调函数设计**：回调函数需简短（避免循环、延时），复杂逻辑建议在回调中设置标志，主线程处理
- **资源释放**：长时间不使用传感器时，调用 `deinit()` 释放中断资源，降低系统功耗

---

### 环境影响
- **温度限制**：避免在高温（>60℃）、低温（<-10℃）环境使用，否则会影响滚珠灵活性
- **湿度限制**：传感器内部为机械结构，高湿环境（>80% RH）可能导致金属部件生锈，缩短寿命
- **安装固定**：传感器需固定安装，避免自身晃动导致误触发（建议使用螺丝或双面胶固定）

## 联系方式
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com  
💻 **GitHub**：[https://github.com/FreakStudioCN](https://github.com/FreakStudioCN)  

---

## 许可协议
本项目中，除 `machine`、`time` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (CC BY-NC 4.0)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。您可以用任何合理的方式来署名，但是不得以任何方式暗示许可人为您或您的使用背书。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。  

**版权归 FreakStudio 所有。**