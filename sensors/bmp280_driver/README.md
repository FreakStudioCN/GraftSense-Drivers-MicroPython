# BMP280 温湿度气压传感器驱动 - MicroPython版本

## 目录
- [简介](#简介)
- [主要功能](#主要功能)
- [硬件要求](#硬件要求)
- [文件说明](#文件说明)
- [软件设计核心思想](#软件设计核心思想)
- [使用说明](#使用说明)
- [示例程序](#示例程序)
- [注意事项](#注意事项)
- [联系方式](#联系方式)
- [许可协议](#许可协议)

---

## 简介
BMP280 是一款集成温度、湿度和气压测量功能的高精度传感器，采用 I2C 通信接口，广泛应用于气象监测、环境控制、物联网设备等场景。该传感器具有低功耗、高精度、宽测量范围等特点，能够同时提供环境温度（°C）、相对湿度（%）和大气压强（hPa）数据，并支持海拔高度和露点温度计算。

本项目提供基于 MicroPython 的 BMP280 驱动代码（浮点型版本）及测试程序，方便开发者快速集成传感器功能。

---

## 主要功能
- **多参数测量**：同时采集温度、湿度和气压数据
- **扩展计算**：支持海拔高度（基于气压）和露点温度（基于温湿度）计算
- **采样精度配置**：可设置不同的采样精度（1~16次采样）
- **数据格式化**：提供原始浮点数据和格式化字符串输出
- **校准补偿**：内置传感器校准参数读取与数据补偿算法
- **跨平台支持**：兼容所有支持 MicroPython 的硬件平台（如 ESP32、ESP8266、树莓派 Pico 等）

---

## 硬件要求
### 推荐测试硬件
- 支持 MicroPython 的开发板（如 ESP32、ESP8266、树莓派 Pico）
- BMP280 传感器模块
- 杜邦线若干

### 模块引脚说明
| BMP280 引脚 | 功能描述                          |
|-----------|-------------------------------|
| VCC       | 电源正极                          |
| GND       | 电源负极                          |
| SCL       | I2C 时钟线                       |
| SDA       | I2C 数据线                       |
| CSB       | 芯片选择（I2C模式下接高电平，默认内部上拉）       |
| SDO       | 地址选择（接GND时地址为0x76，接VCC时为0x77） |

---
## 文件说明
### bmP280_float.py
核心驱动文件，包含 `BMP280` 类实现传感器控制：

- **类 `BMP280`**：BMP280 传感器控制核心类，提供完整的数据读取与处理功能
  
  - `__init__()`：初始化传感器，加载校准参数，配置采样模式和 I2C 通信
  - `read_raw_data(result)`：读取原始温度、气压、湿度数据到指定数组
  - `read_compensated_data(result=None)`：返回经过校准的浮点型温度(°C)、气压(Pa)和湿度(%)
  - `sealevel`（属性）：获取或设置海平面标准气压（Pa），用于海拔计算
  - `altitude`（属性）：根据当前气压和海平面气压计算海拔高度（米）
  - `dew_point`（属性）：基于当前温度和湿度计算露点温度（°C）
  - `values`（属性）：返回格式化的温度("xx.xxC")、气压("xxxx.xxhPa")、湿度("xx.xx%")字符串元组

### main.py
测试程序文件，主要功能：

- 初始化 I2C 总线和 BMP280 传感器实例
- 循环读取传感器数据（温度、气压、湿度、海拔、露点）
- 打印原始数据和格式化数据，验证传感器工作状态
- 支持键盘中断（Ctrl+C）优雅终止程序

---

## 软件设计核心思想
### 校准补偿机制
- 读取传感器内置的校准参数（dig_Tx、dig_Px、dig_Hx系列）
- 基于校准参数对原始数据进行补偿计算，提高测量精度
- 温度数据用于气压和湿度的补偿计算（t_fine变量传递）

### 分层设计
- 底层：原始数据读取（read_raw_data）
- 中层：数据补偿转换（read_compensated_data）
- 高层：应用级计算（altitude、dew_point）和格式化输出（values）

### 资源优化
- 使用复用缓冲区（bytearray和array）减少内存分配
- 通过属性（@property）封装常用计算，实现按需计算
- 限制测量范围（如湿度0~100%，温度-40~85°C）确保数据有效性

### 接口抽象
- 统一的I2C接口，屏蔽不同硬件平台的差异
- 灵活的采样模式配置，支持单一模式或分别配置温湿度气压采样精度

---

## 使用说明
### 硬件接线（树莓派pico 示例）

| BMP280 引脚 |GPIO 引脚 |
|-----------|---------------|
| VCC       | 5V            |
| GND       | GND           |
| SCL       | GPIO21        |
| SDA       | GPIO20        |

> **注意：**
> - 传感器仅支持5V供电
> - 不同开发板的I2C引脚可能不同，请根据实际硬件修改
> - SDO引脚接地时I2C地址为0x76，接VCC时为0x77

---

### 软件依赖
- **固件版本**：MicroPython v1.19+
- **内置库**：
  - `machine`（用于I2C和GPIO控制）
  - `time`（用于延时）
  - `struct`、`array`、`micropython`（驱动内部使用）
- **开发工具**：PyCharm 或 Thonny（推荐）

---

### 安装步骤
1. 将 MicroPython 固件烧录到开发板
2. 上传 `bmp280_float.py` 和 `main.py` 到开发板
3. 根据硬件连接修改 `main.py` 中的I2C引脚配置
4. 运行 `main.py` 开始测试

---

## 示例程序
```python
# Python env   : MicroPython v1.23.0
# -*- coding: utf-8 -*-
# @Time    : 2025/9/9 上午11:25
# @Author  : 缪贵成
# @File    : main.py
# @Description : 基于BMP280的大气压强温湿度传感器模块驱动测试程序

# ======================================== 导入相关模块 =========================================

import time
from machine import I2C
from bmp280_float import BMP280

# ======================================== 全局变量 =============================================

bmp_addr = None

# ======================================== 功能函数 =============================================

# ======================================== 自定义类 =============================================

# ======================================== 初始化配置 ============================================

time.sleep(3)
print("FreakStudio:Testing BMP280 pressure, temperature, and humidity sensor")
# 注意：引脚号根据实际硬件修改
i2c = I2C(0, scl=1, sda=0, freq=100000)
# 开始扫描I2C总线上的设备，返回从机地址的列表
devices_list:list[int] = i2c.scan()
print('START I2C SCANNER')
# 若devices list为空，则没有设备连接到I2C总线上
if len(devices_list) == 0:
    # 若非空，则打印从机设备地址
    print("No i2c device !")
else:
    print('i2c devices found:', len(devices_list))
for device in devices_list:
    if 0x60 <= device <= 0x7A:
        print("I2c hexadecimal address:", hex(device))
        bmp_addr = device

bmp = BMP280(i2c=i2c, address=bmp_addr)

# ======================================== 主程序 ===============================================
try:
    while True:
        # 获取浮点数温湿度和气压
        temp, press, hum = bmp.read_compensated_data()
        # 转换气压单位为 hPa（1 hPa = 100 Pa）
        press_hpa = press / 100.0
        # 计算海拔高度
        sea_level_hpa = 1013.25
        altitude = 44330.0 * (1.0 - (press_hpa / sea_level_hpa) ** 0.1903)
        # 打印浮点信息
        print("Temperature: {:.2f} °C | Humidity: {:.2f}% | Pressure: {:.2f} hPa".format(
            temp, hum, press_hpa
        ))
        print(altitude)
        time.sleep(2)
except KeyboardInterrupt:
    print("\nTest stopped")




```
---
## 注意事项
### 电源要求
- 必须使用 3.3V 电源供电，接 5V 会损坏传感器
- 确保电源稳定，避免电压波动影响测量精度
- 长距离接线时建议在 SDA 和 SCL 线上添加 10K 上拉电阻

### 测量范围
| 参数 | 测量范围 | 精度 |
|------|----------|------|
| 温度 | -40 ~ 85 °C | ±1.0 °C |
| 湿度 | 0 ~ 100 %RH | ±3 %RH |
| 气压 | 300 ~ 1100 hPa | ±1 hPa |

### 采样模式
- 采样次数越多，精度越高，但功耗和测量时间也越长
- 推荐模式：BMP280_OSAMPLE_8（平衡精度和效率）
- 可通过 tuple 分别设置湿度、温度、气压的采样模式，例如 `mode=(BMP280_OSAMPLE_16, BMP280_OSAMPLE_8, BMP280_OSAMPLE_4)`

### 海拔计算
- 海拔高度计算依赖海平面气压设置（默认 101325 Pa）
- 可通过 `bmp.sealevel = 101300` 调整海平面气压值（单位 Pa）
- 实际应用中建议根据当地海拔校准海平面气压

### 软件限制
- I2C 操作非 ISR-safe，不要在中断服务程序中调用
- 传感器初始化时会读取校准数据，需确保 I2C 通信正常
- 连续读取间隔建议不小于 100ms，避免数据不稳定
---
## 联系方式
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 邮箱：10696531183@qq.com  
💻 GitHub：https://github.com/FreakStudioCN
---
## 许可协议
本项目中，除 `machine` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (CC BY-NC 4.0)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。
- **声明** —代码含有参考部分，产生问题与署名作者无关。

**版权归 FreakStudio 所有。**