# ds18x20温度传感器驱动 - MicroPython版本
## 目录
- [简介](#简介)
- [主要功能](#主要功能)
- [硬件要求](#硬件要求)
- [文件说明](#文件说明)
- [软件设计核心思想](#软件设计核心思想)
- [使用说明](#使用说明)
- [示例程序](#示例程序)
- [注意事项](#注意事项)
- [联系方式](#联系方式)
- [许可协议](#许可协议)
---
## 简介

DS18x20 系列是一类基于 **单总线（One-Wire）协议** 的数字温度传感器，常见型号包括 DS18B20、DS18S20。它内部集成温度采集、模数转换及数字接口电路，可直接输出摄氏度温度数据，具有高精度、单线通信、可多点并联等特点，广泛应用于环境监测、智能家居、工业控制等场景。本项目提供基于 MicroPython 的驱动代码，封装设备扫描、温度读取、摄氏度转换功能，支持快速集成。

> **注意**：适用于 DS18x20 系列数字温度传感器，不适用于模拟热敏电阻，不可在超过器件耐压范围的高温或强电磁干扰环境下使用。

---

## 主要功能

* 初始化单总线接口，支持多传感器挂载
* 读取原始温度寄存器数据并转换为摄氏度
* 聚合返回完整温度状态信息，支持摄氏度/华氏度切换
* 兼容 MicroPython 主流开发板，接口简洁易用

---

## 硬件要求

### 推荐测试硬件

* MicroPython 开发板（如树莓派 Pico）、DS18B20 传感器、4.7KΩ 上拉电阻、杜邦线若干、（可选）面包板

### 模块引脚说明

| DS18x20 引脚 | 功能描述  | 连接说明                         |
| ---------- | ----- | ---------------------------- |
| VDD        | 电源输入  | 接开发板 3.3V（或 5V，取决于器件版本）      |
| DQ         | 单总线数据 | 接开发板 GPIO（需外接 4.7KΩ 上拉到 VDD） |
| GND        | 接地    | 接开发板 GND                     |

---

## 文件说明
### ds18x20.py

该文件实现 **DS18x20 系列温度传感器** 的核心驱动功能，包含 `DS18X20` 类和对 `OneWire` 协议的支持，用于通过单总线协议与 DS18B20、DS18S20 等温度传感器进行通信。

`DS18X20` 类通过封装温度转换与数据读取逻辑，提供简洁的温度采集接口。类的主要成员说明如下：

* `ow (OneWire)`：单总线通信对象，由应用层传入，负责底层读写操作。
* `buf (bytearray)`：暂存器数据缓冲区（9 字节），用于保存传感器内部寄存器数据。
* `config (bytearray)`：用户配置数据缓冲区（3 字节），用于设置分辨率等参数。
* `power (int)`：电源模式，`1` 表示独立供电，`0` 表示寄生供电。
* `powerpin (Pin)`：供电引脚对象（用于寄生供电模式）。

类的主要方法包括：

* `__init__(onewire: OneWire) -> None`：初始化传感器驱动，绑定 OneWire 对象。
* `powermode(powerpin: Pin = None) -> int`：设置并返回电源模式。
* `scan() -> list[bytearray]`：扫描总线并返回 ROM 地址列表。
* `convert_temp(rom: bytearray = None) -> None`：启动温度转换（可对指定 ROM 或所有设备）。
* `read_scratch(rom: bytearray) -> bytearray`：读取暂存器数据。
* `write_scratch(rom: bytearray, buf: bytearray) -> None`：写入暂存器数据。
* `read_temp(rom: bytearray) -> float`：读取温度（摄氏度）。
* `resolution(rom: bytearray, bits: int = None) -> int`：设置或获取分辨率。
* `fahrenheit(celsius: float) -> float`：摄氏度转华氏度。
* `kelvin(celsius: float) -> float`：摄氏度转开氏度。

---

### main.py

该文件为 **温度传感器的功能测试程序**，无自定义类，仅包含主程序入口。

主程序的核心功能是：

1. 初始化用于 OneWire 通信的 GPIO 引脚，创建 `OneWire` 和 `DS18X20` 驱动实例；
2. 扫描总线上的 DS18B20 设备并打印 ROM ID；
3. 启动温度转换，并在循环中周期性读取并打印温度数据（默认间隔 0.5 秒）；
4. 程序支持通过 `Ctrl+C` 手动终止，适用于验证 DS18x20 硬件连接与驱动功能是否正常。

---

## 软件设计核心思想

* **模块化**：驱动与应用分离，`ds18x20.py` 专注于协议与数据操作，`main.py` 负责应用逻辑。
* **协议封装**：对 OneWire 协议读写操作进行抽象，简化应用层调用。
* **硬件解耦**：OneWire 对象由应用层传入，驱动层不负责硬件初始化，保证兼容性。

---

## 使用说明

### 硬件接线（树莓派 Pico 示例）

| DS18B20 引脚 | Pico 引脚     | 接线功能                       |
| ---------- | ----------- | -------------------------- |
| VDD        | 3.3V（Pin36） | 电源输入                       |
| DQ         | GP14（Pin19） | 单总线数据（需接 4.7KΩ 上拉电阻到 3.3V） |
| GND        | GND（Pin38）  | 接地                         |

### 软件依赖

* 固件：MicroPython v1.23+
* 内置库：`machine`（GPIO 控制）、`time`（延时）
* 自定义库：`onewire.py`、`ds18x20.py`
* 开发工具：Thonny / PyCharm

### 安装步骤

1. 烧录 MicroPython 固件到开发板；
2. 上传 `onewire.py` 和 `ds18x20.py` 到开发板；
3. 上传并运行 `main.py`，串口终端可实时打印温度。

---
## 示例程序
```python
# Python env   : MicroPython v1.23.0
# -*- coding: utf-8 -*-        
# @Time    : 2024/7/22 下午3:01   
# @Author  : 李清水            
# @File    : main.py       
# @Description : DS18B20温度类实验，使用单总线通信完成数据交互

# ======================================== 导入相关模块 ========================================

# 导入硬件相关的模块
from machine import Pin
# 导入时间相关的模块
import time
# 导入单总线通信相关的模块
from onewire import OneWire
# 导入温度传感器类
from ds18x20 import DS18X20

# ======================================== 全局变量 ============================================

# ======================================== 功能函数 ============================================

# ======================================== 自定义类 ============================================

# ======================================== 初始化配置 ==========================================

# 延时等待设备初始化
time.sleep(3)
# 打印调试信息
print('FreakStudio : Using OneWire to read DS18B20 temperature')

# 定义单总线通信引脚
ow_pin = OneWire(Pin(14))
# 定义温度传感器
ds18x20 = DS18X20(ow_pin)

# ========================================  主程序  ===========================================

# 扫描总线上的DS18B20，获取设备地址列表
roms_list = ds18x20.scan()
# 打印设备地址列表
for rom in roms_list:
    print('ds18b20 sensor devices rom id:', rom)
# 让所有挂载在总线上的DS18B20转换温度
ds18x20.convert_temp()

# 循环读取温度
while True:
    time.sleep_ms(500)
    for rom in roms_list:
        # 转换并打印温度
        temp = ds18x20.read_temp(rom)
        # 打印温度
        print('ds18b20 sensor {} devices temp {}'.format(rom, temp))
    # 启动温度转换
    ds18x20.convert_temp()
```
---
## 注意事项
### 电气特性限制

* **电源电压**：DS18B20 推荐工作电压范围 3.0V \~ 5.5V，若使用 3.3V 开发板请确认型号兼容。
* **上拉电阻**：DQ 数据线必须外接 4.7KΩ 电阻到 VDD，否则总线通信可能失败。
* **寄生供电模式**：若省略 VDD 引脚，需将 DQ 上拉电阻改接到 5V，并在转换时提供额外电流；推荐使用独立供电模式以保证稳定性。

### 环境影响

* **温度范围**：DS18B20 测温范围 -55℃ \~ +125℃，典型精度 ±0.5℃（-10℃ \~ +85℃）。
* **防护要求**：传感器裸封装不防水，若应用于液体或户外环境需使用防水封装版本或保护套管。
* **电磁干扰**：单总线信号线需尽量短且远离强干扰设备，必要时使用屏蔽线。

---
### 联系方式
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com  
💻 **GitHub**：[https://github.com/FreakStudioCN](https://github.com/FreakStudioCN)  

---
### 许可协议
本项目中，除 `machine` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (CC BY-NC 4.0)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。您可以用任何合理的方式来署名，但是不得以任何方式暗示许可人为您或您的使用背书。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。  

**版权归 FreakStudio 所有。**