# DHT22温湿度传感器驱动 - MicroPython版本

## 目录
- [简介](#简介)
- [主要功能](#主要功能)
- [硬件要求](#硬件要求)
- [文件说明](#文件说明)
- [软件设计核心思想](#软件设计核心思想)
- [使用说明](#使用说明)
- [示例程序](#示例程序)
- [注意事项](#注意事项)
- [联系方式](#联系方式)
- [许可协议](#许可协议)

---

## 简介
DHT22 是一种常见的数字温湿度传感器，通过单总线协议与主控芯片（如 Raspberry Pi Pico）通信，能够输出温度与湿度的数字信号。相比模拟传感器，DHT22 具备精度高、输出稳定、抗干扰能力强的特点，广泛用于环境监测、智能家居、气候记录等场景。

本项目提供基于 MicroPython 的 DHT22 驱动代码及测试程序，支持温度、湿度实时读取、错误校验、数据缓存等核心功能，便于快速集成到气象站、温控系统、物联网终端等应用中。

> **注意**：DHT22 响应速度较慢（采样周期 ≥ 2 秒），不宜高频率读取；否则可能返回无效数据。

---

## 主要功能
### 1. 基础转速控制
- **`get_temperature()`**：获取温度值（℃）
- **`get_humidity()`**：获取湿度值（%）
- **`get_temperature_and_humidity()`**：同时获取温度与湿度，减少额外读取

### 2. 状态查询与硬件访问
- **`_get_data_from_sensor()`**：从 DHT 传感器读取一次完整的温湿度数据（内部方法）

### 3. 兼容性与安全性优化
- **采样间隔限制**：默认最小间隔 2000ms（适配 DHT22），避免频繁采样导致传感器响应失败
- **数据校验**：接收 40 位数据后，自动执行校验和验证，校验失败会丢弃数据（返回 None）
- **负温度处理**：温度高字节最高位为 1 时，自动识别为负数（DHT22 支持负温度）
- **精度适配**：温度、湿度数据均按 DHT22 的 10 倍精度解析（例如 256 → 25.6℃）

### 4. 易用性设计
- **接口简洁**：提供 3 个核心方法（温度、湿度、温湿度）即可完成常见需求
- **默认安全配置**：初始化即启动 PIO 状态机，但不会自动采样，需主动调用接口
- **可扩展性**：结合风扇控制，可轻松实现“温湿度 → 风扇转速”的闭环控制逻辑。

---

## 硬件要求
### 推荐测试硬件
| 硬件组件                     | 规格要求                               | 作用说明                       |
| ------------------------ | ---------------------------------- | -------------------------- |
| Raspberry Pi Pico/Pico W | MicroPython v1.23+ 固件              | 驱动控制核心，运行 PIO 程序与 DHT22 通信 |
| DHT22 温湿度传感器             | 工作电压 3.3V\~6V，单总线数据通信              | 采集环境温度与湿度数据                |
| 上拉电阻                     | 4.7kΩ\~10kΩ，连接在数据引脚与 VCC 之间        | 提供单总线数据线稳定电平，确保通信可靠        |
| 电源模块                     | 输出电压与 DHT22 额定电压一致（如 3.3V 或 5V 电源） | 为 DHT22 提供稳定供电             |
| 杜邦线/端子线                  | 28AWG 或更粗                          | 硬件连接，确保数据线、VCC、GND 可靠连接    |
| （可选）外壳/防护罩               | 透气外壳，避免阳光直射、雨水浸入                   | 提升传感器寿命与数据稳定性              |

---

### 硬件接线方案（Raspberry Pi Pico 示例）
| DHT22 引脚   | 连接对象              | 中间元件             | 作用说明                              |
| ---------- | ----------------- | ---------------- | --------------------------------- |
| VCC（电源正极）  | 3.3V 或 5V 电源正极    | 无                | 为传感器提供工作电源（推荐使用 3.3V，与 Pico 电平一致） |
| DATA（数据引脚） | Pico GPIO（如 GP15） | 4.7kΩ\~10kΩ 上拉电阻 | 单总线数据通信，需上拉至 VCC 保持信号稳定           |
| GND（电源负极）  | Pico GND          | 无                | 共地，保证数据传输电平正确                     |
| NC（悬空脚）    | 不连接               | 无                | 内部未使用，引脚悬空即可                      |

---

> **关键提醒**：
> 1. DHT22 供电电压范围宽（3.3V\~6V），但推荐 **与 Pico 共用 3.3V 电源**，避免电平不匹配。
> 2. 数据引脚必须接 **4.7kΩ\~10kΩ 上拉电阻**，否则可能出现读取失败或不稳定。
> 3. DHT22 每次采样需间隔 **至少 2 秒**，频繁采样会导致传感器响应异常。
> 4. 为保证测量准确，建议将 DHT22 放在通风良好且无强烈热源直射的位置。

---

## 文件说明
### 1. dht22.py（核心驱动文件）
实现 DHT22 数字温湿度传感器的驱动逻辑，核心类 `DHT` 封装了温度和湿度读取接口，关键代码解析如下：

| 类方法/属性              | 功能描述              | 关键实现细节                                                                                 |
| ------------------- | ----------------- | -------------------------------------------------------------------------------------- |
| `__init__(pin)`     | 初始化传感器引脚          | 1. 传入 `Pin` 对象（通常为 GPIO 输入输出复用引脚）；<br>2. 配置输入输出模式切换，用于起始信号与数据接收。                       |
| `get_temperature()` | 读取并返回当前温度（单位：℃）   | 解析传感器返回的 40 位数据中的高 16 位温度信息，支持负温度处理。                                                   |
| `get_humidity()`    | 读取并返回当前湿度（单位：%RH） | 解析传感器返回的 40 位数据中的高 16 位湿度信息。                                                           |
| `_get_data_from_sensor()`（内部自动调用） | 执行一次完整的数据采集流程     | 1. 主机拉低数据线 ≥18ms 触发传感器响应；<br>2. 读取 DHT22 的响应脉冲；<br>3. 逐位采样 40bit 数据；<br>4. 校验和验证数据有效性。 |

### 2. main.py（测试程序）
演示 `DHT` 类的完整使用流程，包括：
1. 上电延时 2 秒（确保传感器稳定上电）；
2. 初始化 DHT22（默认引脚 GP0）；
3. 循环读取温度与湿度并打印结果（每 2 秒一次）。

---

## 软件设计核心思想

### 1. 数据采集与解码

* **标准协议实现**：遵循 DHT22 通信时序，通过精确延时与电平采样获取 40bit 数据；
* **自动解码**：驱动类在调用 `get_temperature()` 或 `get_humidity()` 时会自动触发一次采样，不需要用户手动调用 `measure()`；
* **校验机制**：每次采集数据都进行校验和验证，避免因干扰产生错误读数。

### 2. 稳定性与兼容性

* **上电延时**：DHT22 上电后需要约 1\~2 秒稳定时间，因此程序在 `main.py` 入口处 `sleep(2)`；
* **采样间隔**：根据官方规格，采样周期建议 ≥2 秒，否则可能返回重复或无效数据；
* **引脚灵活性**：用户可通过修改 `Pin(0)` 来选择任意可用 GPIO 作为数据线。

### 3. 可维护性与扩展性

* **接口简洁**：仅提供 `get_temperature()` 和 `get_humidity()`，避免用户关心底层时序细节；
* **解耦设计**：驱动类与主程序分离，便于扩展（如将数据上传到 MQTT/数据库或结合风扇控制实现温控系统）。

---

## 使用说明
### 1. 硬件接线步骤（以 Pico + DHT22 模块为例）
1. **供电线路**：
   * DHT22 VCC → Pico 3.3V 引脚；
   * DHT22 GND → Pico GND 引脚。
2. **数据线连接**：
   * DHT22 DATA → Pico GP0 引脚（需在 VCC 与 DATA 之间接 4.7kΩ 上拉电阻）。

### 2. 软件部署与测试
1. **固件准备**：为 Raspberry Pi Pico 烧录 MicroPython v1.23+ 固件；
2. **文件上传**：通过 Thonny 或 PyCharm（MicroPython 插件）将 `dht22.py` 和 `main.py` 上传到 Pico 文件系统；
3. **参数配置**：根据实际接线修改 `main.py` 中 `Pin(0)` 的 `0` 为目标 GPIO 编号；
4. **运行测试**：执行 `main.py`，观察串口输出，应周期性打印温度与湿度数据。
---
## 示例程序
* python
```python
# Python env   : MicroPython v1.23.0
# -*- coding: utf-8 -*-
# @Time    : 2025/9/1 上午11:22
# @Author  : ben0i0d
# @File    : main.py
# @Description : dht22驱动测试文件 测试输出温度
# @License : CC BY-NC 4.0

# ======================================== 导入相关模块 =========================================

import dht22
from machine import Pin
from utime import sleep

# ======================================== 全局变量 ============================================

# ======================================== 功能函数 ============================================

# ======================================== 自定义类 ============================================

# ======================================== 初始化配置 ===========================================

# ========================================  主程序  ============================================

if __name__ == '__main__':
    sleep(2)
    dht_pin = Pin(0)
    d = dht22.DHT(dht_pin)
    while True:
        print('Temperature: {}. Humidity: {}'.format(d.get_temperature(), d.get_humidity()))
        sleep(2)
```
---
## 注意事项

### 1. 硬件安全限制
#### （1）供电匹配：避免电压/电流不兼容

* **电压要求**：DHT22 工作电压范围 **3.3V\~6V**，推荐使用 **3.3V** 与 Raspberry Pi Pico 电平匹配，避免信号电平不一致；
* **电流承载**：DHT22 工作电流通常 <2.5mA，对电源要求不高，但必须保证 VCC 与 GND 接触良好，否则可能导致数据丢失；
* **数据引脚保护**：DATA 引脚必须串联 **4.7kΩ\~10kΩ 上拉电阻**，否则信号可能悬浮，导致 Pico 读取失败。

#### （2）采样间隔：避免过度读取
* DHT22 内部采样周期约为 **2 秒**，若读取间隔过短，会返回重复数据或无效数据；
* 正确做法：确保连续两次读取之间间隔 ≥2000ms（驱动已内置 `_min_interval=2000` 限制）。
---

### 2. 环境影响与维护
#### （1）温度与湿度
* DHT22 工作环境范围：**-40℃\~80℃，0%\~100% RH**；
* 高湿环境下（>90% RH），传感器探头可能会因冷凝水而导致数据短时失真；
* 避免将 DHT22 放置在强热源（如散热片、直射阳光）附近，否则会导致温度偏高。

#### （2）灰尘与防护
* 长期暴露在粉尘环境中，DHT22 的透气外壳可能被堵塞，导致采样延迟或数据不准；
* 建议每 **6 个月** 检查一次：轻轻吹除传感器外壳灰尘，避免使用高压气体或液体清洁；
* 室外环境下，建议为 DHT22 增加 **透气防护罩**（如百叶壳），既能防水又能保证空气流通。
---

### 3. 常见问题排查

| 问题现象       | 可能原因                                                                  | 解决方案                                                                                                             |
| ---------- | --------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- |
| 始终读取不到数据   | 1. DATA 引脚未接上拉电阻；<br>2. VCC/GND 接线错误；<br>3. PIO 状态机未正确启动              | 1. 确认数据线加 4.7kΩ\~10kΩ 上拉电阻；<br>2. 用万用表确认 VCC=3.3V 或 5V，且 GND 共地；<br>3. 检查代码初始化逻辑，确保 `StateMachine.active(1)` 已调用 |
| 数据返回 None  | 1. 读取间隔 <2s，导致采样失败；<br>2. 校验和不匹配（信号干扰或数据错误）；<br>3. 环境温度/湿度超出 DHT22 范围 | 1. 增加 `utime.sleep(2)` 保证采样间隔；<br>2. 检查电源稳定性，确保上拉电阻正确；<br>3. 检查传感器放置环境是否过热或冷凝                                    |
| 温度/湿度数值不合理 | 1. 放置在热源或直射阳光下；<br>2. 长期暴露在灰尘/水汽中，透气外壳堵塞；<br>3. 电源波动，导致数据采样异常         | 1. 移动至通风、无直射环境；<br>2. 定期清理外壳灰尘，必要时更换传感器；<br>3. 使用稳定电源模块，避免 USB 供电波动                                              |
| 第一次读取失败    | 1. DHT22 上电后需初始化时间（约 1s）；<br>2. 驱动启动后立即读取数据                           | 1. 在上电后延时 1s 再执行第一次采样；<br>2. 驱动初始化后调用 `utime.sleep(2)` 再读数据                                                      |

---
## 联系方式

如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com  
💻 **GitHub**：[https://github.com/leezisheng](https://github.com/leezisheng)  

---

## 许可协议
本项目中，除 `machine` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (CC BY-NC 4.0)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。您可以用任何合理的方式来署名，但是不得以任何方式暗示许可人为您或您的使用背书。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。  

**版权归 FreakStudio 所有。**
