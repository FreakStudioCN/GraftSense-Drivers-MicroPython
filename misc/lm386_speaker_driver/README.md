# LM386 功率放大扬声器模块驱动 - MicroPython版本（树莓派Pico专属）

## 目录
- [简介](#简介)
- [主要功能](#主要功能)
- [硬件要求](#硬件要求)
- [文件说明](#文件说明)
- [软件设计核心思想](#软件设计核心思想)
- [使用说明](#使用说明)
- [示例程序](#示例程序)
- [注意事项](#注意事项)
- [联系方式](#联系方式)
- [许可协议](#许可协议)

---

## 简介
LM386 是一款低电压功率放大芯片，搭配扬声器组成功率放大模块后，可将树莓派Pico输出的微弱PWM信号放大，驱动扬声器发声，适用于嵌入式场景中的报警提示、简单旋律播放、交互反馈等需求。该模块具有外围电路简单、功耗低（3V-12V供电）、成本低廉等特点。

本项目提供基于MicroPython的LM386驱动代码及树莓派Pico专属测试程序，通过PWM生成方波音调，实现单音播放、音符序列播放及音量调节，充分适配树莓派Pico的硬件特性。

> **注意**：仅支持方波音调生成，不支持音频文件（MP3/WAV）解码，不适用于高保真音频场景。

---

## 主要功能
- **树莓派Pico深度适配**：针对Pico的PWM硬件特性优化，支持Pico所有GPIO（除ADC引脚）的PWM功能，适配Pico专属的0-65535 PWM占空比范围
- **基础音调控制**：支持20Hz-20kHz人耳可听频率的单音播放，时长可自定义（0.1秒-任意时长）
- **旋律播放**：支持自定义音符序列（频率+时长），自动添加0.05秒音符间隔，避免Pico处理过快导致音调叠加
- **音量调节**：1%-100%音量百分比调节，自动映射为Pico的PWM占空比（如50%音量对应32768占空比）
- **快速静音**：`stop()`方法即时停止播放，通过设置PWM占空比为0实现静音，无残留杂音
- **低资源占用**：初始化时仅创建1个PWM实例，内存占用≤1KB，不影响Pico其他外设（如I2C、SPI）的正常使用

---

## 硬件要求
### 推荐测试硬件
- 树莓派Pico/Pico W开发板（必须，核心控制硬件）
- LM386功率放大扬声器模块（含8Ω/0.5W自带扬声器，或模块+独立8Ω扬声器）
- 杜邦线（公对母，至少4根，用于Pico与模块的引脚连接）
- 5V/1A外接电源（推荐，Pico的USB 5V可临时供电，高音量或长时间播放需外接电源）
- （可选）面包板（便于临时接线测试，避免引脚接触不良）

### 模块引脚与树莓派Pico接线说明
| LM386 模块引脚 | 功能描述 | 树莓派Pico引脚（物理引脚/功能引脚） | 接线备注 |
|----------------|----------|----------------------|----------|
| VCC            | 电源正极 | 物理引脚40（5V）或外接5V电源    | 模块供电核心引脚，推荐外接5V/1A电源（Pico的USB 5V仅支持临时低音量使用，高音量易因供电不足导致杂音） |
| GND            | 电源负极 | 物理引脚38（GND）或39（GND）  | 必须与Pico共地（包括外接电源的GND也需与Pico GND连接），否则模块无驱动信号、扬声器无声音 |
| IN             | 信号输入（PWM） | 物理引脚20（GP6）          | 接收Pico的PWM信号，也可选择Pico其他GPIO（如GP12、GP13、GP14，避开GP26-GP28 ADC引脚，避免干扰ADC功能） |

---

## 文件说明
### 1. lm386_speaker.py
核心驱动文件，包含`LMSpeaker`类，针对树莓派Pico的PWM特性编写，各类与方法作用如下：

- **核心类 `LMSpeaker`**：封装树莓派Pico的PWM控制逻辑，提供发声与音量调节接口
  - `__init__(self, pin: int, freq: int = 1000)`：初始化扬声器实例；参数`pin`为树莓派Pico的GPIO编号（如15对应GP15），`freq`为默认PWM频率（默认1000Hz）；初始化时自动创建PWM实例并设置为静音（duty_u16=0），适配Pico的PWM初始化逻辑。
  - `_init_pwm(self)`：内部辅助方法，仅用于初始化Pico的PWM硬件，设置默认频率与静音状态，不对外暴露。
  - `play_tone(self, frequency: int, duration: float)`：播放单音；参数`frequency`为音调频率（20Hz-20kHz，需在Pico PWM频率支持范围内），`duration`为播放时长（秒）；播放时自动调整Pico的PWM频率，播放结束后调用`stop()`静音，适配Pico的PWM频率切换速度。
  - `play_sequence(self, notes: list[tuple[int, float]])`：播放音符序列；参数`notes`为列表，每个元素为`(频率, 时长)`元组（如`[(440, 0.5), (494, 0.5)]`）；音符间自动添加0.05秒延时，避免Pico处理过快导致音调重叠。
  - `set_volume(self, percent: int)`：调节音量；参数`percent`为音量百分比（1-100），自动映射为Pico的PWM占空比（如10%对应6553，100%对应65535）；超出1-100范围时自动钳位（低于1按1处理，高于100按100处理），适配Pico的`duty_u16`接口。
  - `stop(self)`：停止播放并静音；通过设置Pico的PWM占空比为0实现，无参数无返回值，可在任意时刻调用。

### 2. main.py
无自定义类，针对树莓派Pico的硬件与串口特性编写测试逻辑：
- 初始化延时3秒，等待树莓派Pico上电稳定（避免Pico未就绪导致的初始化失败）。
- 打印测试提示信息（通过Pico的串口输出，可在Thonny中查看）。
- 创建`LMSpeaker`实例，默认使用树莓派Pico的GP15引脚（物理引脚20），适配Pico的PWM初始化要求。
- 分3阶段测试功能：单音播放（440Hz A4音符）、序列播放（A4-G5音阶）、音量调节（20%-100%）。
- 支持键盘中断（Ctrl+C），捕获后调用`stop()`静音并打印结束信息，避免Pico程序异常。

---

## 软件设计核心思想
### 1. 树莓派Pico硬件特性适配
- **PWM接口专属适配**：仅使用Pico支持的`duty_u16`接口（而非`duty`接口），直接适配Pico的0-65535占空比范围，无需额外转换逻辑。
- **引脚兼容性优化**：不绑定固定引脚，支持Pico所有GPIO（除ADC引脚），开发者可根据实际接线灵活选择PWM引脚，无需修改驱动代码。
- **电源适配考虑**：在文档中明确Pico的USB供电限制，推荐外接电源，避免因Pico供电不足导致的模块异常。

### 2. 易用性与轻量化设计
- **接口简化**：`play_tone()`、`play_sequence()`等方法参数直观（频率用Hz，时长用秒），无需开发者手动计算Pico的PWM寄存器值。
- **资源复用**：初始化时创建唯一PWM实例，避免Pico的PWM硬件资源重复占用（Pico虽支持多PWM通道，但复用可减少内存消耗）。
- **自动处理**：播放结束自动静音、音符间自动加间隔，减少树莓派Pico主程序的代码量，降低开发难度。

---

## 使用说明
### 1. 硬件接线步骤
1. **准备工作**：关闭树莓派Pico的电源（断开USB），取出LM386模块、杜邦线，确认Pico的引脚编号（物理引脚与功能引脚对应关系，可参考Pico官方引脚图）。
2. **连接电源引脚**：
   - 用杜邦线连接LM386模块的`VCC` → 树莓派Pico的物理引脚40（5V），或连接外接5V电源的正极（若用外接电源，需将外接电源的负极与Pico的GND连接）。
   - 用杜邦线连接LM386模块的`GND` → 树莓派Pico的物理引脚38（GND），确保与VCC的电源负极共地（这是模块正常工作的关键，共地不良会导致信号紊乱）。
3. **连接信号引脚**：用杜邦线连接LM386模块的`IN` → 树莓派Pico的物理引脚20（GP15），若需更换引脚，需同步修改`main.py`中的`pin`参数（如改为14对应GP14）。
4. **连接扬声器**：
   - 若LM386模块自带扬声器：无需额外操作（模块出厂已接好SPK+与SPK-）。
   - 若需外接扬声器：用导线连接模块的`SPK+`→扬声器正极、`SPK-`→扬声器负极，确保正负极无反接（可通过扬声器上的“+”“-”标识区分，无标识时可先试接，若音量异常再调换）。
5. **最终检查**：确认所有引脚无反接（尤其是VCC与GND）、无虚接（杜邦线需插紧），避免上电后烧毁树莓派Pico或LM386模块。

### 2. 软件准备（树莓派Pico固件与工具）
- **烧录MicroPython固件**：
  1. 从[MicroPython官网](https://micropython.org/download/rp2-pico/)下载树莓派Pico的MicroPython固件（推荐v1.23.0及以上，格式为.uf2）。
  2. 按住树莓派Pico的`BOOTSEL`按钮，通过USB数据线将Pico连接到电脑，此时Pico会被识别为U盘（名称为RPI-RP2）。
  3. 将下载的.uf2固件文件拖入Pico的U盘，Pico会自动重启并完成固件烧录（烧录成功后U盘会消失）。
- **开发工具安装**：推荐使用Thonny（适配树莓派Pico的MicroPython开发，下载地址：[thonny.org](https://thonny.org/)），安装后打开软件，在右下角设备选择中选择“MicroPython (Raspberry Pi Pico)”并完成连接（首次连接需等待驱动安装）。

### 3. 程序安装与运行（树莓派Pico专属）
1. **创建驱动文件**：在Thonny中新建文件，命名为`lm386_speaker.py`，将驱动代码（`LMSpeaker`类相关代码）复制到文件中，点击“保存”→选择“Raspberry Pi Pico”，保存到Pico根目录（确保文件名无拼写错误，否则`main.py`无法导入）。
2. **创建测试文件**：新建另一个文件，命名为`main.py`，将Pico专属测试代码复制到文件中，同样保存到Pico根目录（两个文件需在同一目录，否则导入失败）。
3. **运行测试**：确认树莓派Pico接线正确且已通过USB连接电脑，点击Thonny的“运行”按钮（▶️），此时Pico会按程序逻辑播放音调（单音→序列→音量调节），同时串口会输出测试信息（如“Playing Single Tone: 440Hz (A4), 1 Second”）；若扬声器无声音，先检查接线（尤其是GND共地与SPK正负极），再排查程序引脚配置。

---

## 示例程序
```python
# Python env   : MicroPython v1.23.0
# -*- coding: utf-8 -*-
# @Time    : 2025/9/9 下午3:31
# @Author  : 缪贵成
# @File    : main.py
# @Description : 基于LM386的功率放大扬声器模块驱动测试文件

# ======================================== 导入相关模块 =========================================

from lm386_speaker import LMSpeaker
import time

# ======================================== 全局变量 ============================================

# ======================================== 功能函数 ============================================

# ======================================== 自定义类 ============================================

# ======================================== 初始化配置 ==========================================

time.sleep(3)
print("FreakStudio:Testing the driving of the LM386-based power amplifier speaker module.")
# 初始化扬声器，假设 PWM 引脚 = 15
speaker = LMSpeaker(pin=6, freq=1000)

# ========================================  主程序  ============================================

print("Play the single tone 440Hz (A4, lasting 3 second) ")
speaker.play_tone(440, 1.0)   # 播放 A4 音符
time.sleep(3)

print("Play the note sequence (simple melody).")
melody = [
    (440, 0.5),  # A4
    (494, 0.5),  # B4
    (523, 0.5),  # C5
    (587, 0.5),  # D5
    (659, 0.5),  # E5
    (698, 0.5),  # F5
    (784, 1.0),  # G5
]
speaker.play_sequence(melody)
time.sleep(1)

print("Test volume adjustment.")
for vol in [20, 40, 60, 80, 100]:
    print("Volume:", vol, "%")
    speaker.set_volume(vol)
    # C5
    speaker.play_tone(523, 0.5)
    time.sleep(0.2)

print("Mute...")
speaker.stop()

```
---
## 注意事项
### 1. 树莓派 Pico 供电安全
- **电源选择细节**：树莓派 Pico 的 USB 接口受电脑 USB 端口限制，通常仅能提供 5V/500mA 电流，而 LM386 模块驱动 8Ω 扬声器时，最大电流约 100mA（5V 供电），看似在 Pico 供电范围内，但实际播放高音量时模块电流会波动，可能导致 Pico 的 3.3V 稳压电路负载过大，出现 PWM 信号失真、扬声器杂音；因此推荐外接 5V/1A 电源（如手机充电器），并将外接电源的 GND 与 Pico 的 GND 用杜邦线连接（共地是关键）。
- **引脚反接防护**：树莓派 Pico 的 GPIO 引脚为 3.3V 电平，且无过压保护，若将 LM386 模块的 VCC（5V）误接至 Pico 的 GPIO，会瞬间烧毁该 GPIO 端口（甚至影响 Pico 主控芯片）；接线时可遵循 “先接 GND、再接信号、最后接 VCC” 的顺序，降低反接风险。
- **扬声器阻抗匹配**：LM386 芯片的最佳负载阻抗为 8Ω，若使用 4Ω 扬声器，会导致模块输出电流增大（超过芯片额定电流），长期使用会烧毁 LM386；若使用 16Ω 扬声器，会因负载阻抗过大导致音量显著降低，无法发挥模块性能，因此必须选择 8Ω 阻抗的扬声器（功率 0.5W-2W 均可）。

### 2. 树莓派 Pico PWM 功能限制
- **引脚选择细节**：树莓派 Pico 的 GP26-GP28 引脚虽支持 PWM，但这三个引脚同时也是 ADC（模拟信号输入）引脚，若用于 PWM 输出，会干扰 ADC 采样精度（如读取传感器模拟信号时出现偏差）；因此推荐使用 GP12-GP15 引脚（物理引脚 16-20），这些引脚仅负责数字信号，无功能冲突，且远离 USB 接口，可减少 USB 信号对 PWM 的干扰。
- **频率与音质关系**：树莓派 Pico 的 PWM 频率调节范围极宽，但人耳对 20Hz-20kHz 以外的频率无感知，无需测试过高或过低的频率；此外，PWM 生成的方波音调本身音质较 “尖锐”，若需改善音质，可在 LM386 模块的 IN 引脚与 GND 之间并联 1 个 104（0.1μF）陶瓷电容，过滤高频杂波（但会轻微降低音量，需平衡选择）。
- **多外设共存**：若树莓派 Pico 同时连接 I2C 设备（如 BME280 传感器）和 LM386 模块，需确保引脚不冲突（如 I2C 0 用 GP0/GP1，LM386 用 GP15），PWM 信号不会干扰 I2C 通信，但需注意接线布局：PWM 信号线（IN 引脚）与 I2C 线（SDA/SCL）保持 5cm 以上距离，避免信号串扰导致 I2C 通信失败。
---
## 联系方式
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 邮箱：10696531183@qq.com  
💻 GitHub：https://github.com/FreakStudioCN
---
## 许可协议
本项目中，除 `machine` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (MIT)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。  

**版权归 FreakStudio 所有。**