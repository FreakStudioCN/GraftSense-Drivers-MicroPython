# MicroPython HC14 LoRa动库

## 目录
- [简介](#简介)
- [主要功能](#主要功能)
- [支持的协议](#支持的协议)
- [硬件要求](#硬件要求)
- [文件说明](#文件说明)
- [软件设计核心思想](#软件设计核心思想)
- [使用说明](#使用说明)
- [示例程序](#示例程序)
- [注意事项](#注意事项)
- [许可协议](#许可协议)

---

## 简介
本项目是一个针对 HC14 LoRa 模块 的 MicroPython 设备驱动库，提供了全面的数据收发与协议封装功能。该库设计简洁、模块化，支持多种主流 LoRa 通信模式，可在多种 MicroPython 兼容硬件平台上运行，适用于物联网节点开发、无线传感网络、远程数据传输等场景。

---

## 主要功能

* 提供非阻塞式 LoRa 数据收发功能
* 支持多种数据封装和解封装模式
* 跨平台兼容：

  * 通信端：Raspberry Pi Pico / 其它 MicroPython 兼容开发板
* 与 uasyncio 兼容，可用于异步应用
* 提供测试程序便于验证和学习

---

## 支持的协议 / 模式

* 点对点（P2P）通信
* 多节点广播
* 简单的包头/校验机制

---

## 硬件要求

### 通信端

* **HC14 LoRa 模块**（433MHz/470MHz/868MHz/915MHz，根据需求选择）
* 连接导线
* 支持 MicroPython 的开发板（如 Raspberry Pi Pico、ESP32 等）

### 接线方式（树莓派 Pico 示例）

| 模块类型         | 引脚功能    | 连接说明                                   |
| ------------ | ------- | -------------------------------------- |
| HC14 LoRa 模块 | VCC     | 接开发板 3.3V（HC14 模块一般工作在 3.3V，请确认规格）     |
| HC14 LoRa 模块 | GND     | 接开发板 GND（共地）                           |
| HC14 LoRa 模块 | TXD     | 接开发板 GPIO RX 引脚（如 Pico 的 GP5/UART1 RX） |
| HC14 LoRa 模块 | RXD     | 接开发板 GPIO TX 引脚（如 Pico 的 GP4/UART1 TX） |
| HC14 LoRa 模块 | AUX/SET | 可选，用于配置模块工作模式（拉高/拉低控制），如 Pico 的 GP2    |

---

## 文件说明

### hc14_lora.py

该文件实现 **HC14 LoRa 模块驱动类**，仅包含 `HC14_Lora` 类，用于通过 UART 接口控制 HC14 模块，支持参数配置与透明传输通信。

`HC14_Lora` 类通过封装 AT 命令交互与透传数据接口，提供模块配置、维护与数据收发功能。类中包含以下主要属性：

* `_uart`：MicroPython UART 对象，用于与 HC14 模块通信。
* `baud`：当前串口波特率（默认 9600，可查询/设置）。
* `channel`：无线信道编号（1–50）。
* `rate`：无线速率参数（S 值，1–8）。
* `power`：发射功率（6–20 dBm）。
* `firmware_version`：固件版本信息字符串。
* `in_at_mode`：标识模块是否处于 AT 命令模式。
* `_line_terminator`：AT 命令结束符（默认 `\r\n`）。

类的主要方法包括：

* `__init__(uart, baud=9600, line_terminator=b'\r\n')`
  初始化驱动对象，绑定 UART，并配置默认参数。
* `test_comm()`
  测试 AT 通信是否正常。
* `reset_defaults()`
  恢复出厂设置。
* `get_baud()` / `set_baud(baud)`
  查询/设置串口波特率。
* `get_channel()` / `set_channel(ch)`
  查询/设置信道。
* `get_rate()` / `set_rate(s)`
  查询/设置无线速率。
* `get_power()` / `set_power(p_dbm)`
  查询/设置发射功率。
* `get_version()`
  查询固件版本信息。
* `get_params()`
  一次性获取所有关键参数。
* `transparent_send(data, wait_between_packets_s=0.01)`
  在透传模式下发送数据（支持自动分包）。
* `transparent_recv(max_total_bytes=1024)`
  在透传模式下接收数据。
* `close()`
  关闭 UART 资源。

---

### main.py

该文件为 **HC14 LoRa 测试程序**，无自定义类，仅包含程序入口逻辑。

主程序功能：

* 上电后延时 3 秒，确保模块稳定启动。
* 通过 **KEY 引脚** 控制模块进入 AT 模式。
* 创建 `HC14_Lora` 驱动实例，并进行以下操作：

  * 测试 AT 通信是否正常
  * 获取固件版本信息
  * 批量读取模块关键参数
* 切换至透传模式，执行循环收发：

  * 接收远端数据并打印
  * 自动回发带前缀的应答消息

该程序可用于验证 **模块接线正确性、AT 配置功能与透传通信是否正常**。

---

## 软件设计核心思想

* **模块化**：驱动与应用分离，`HC14_Lora` 负责底层交互，主程序专注逻辑。
* **面向对象**：通过类封装参数和方法，统一管理模块状态，接口清晰。
* **模式分离**：支持 **AT 命令模式** 与 **透传模式**，保证配置和通信的灵活性。
* **跨平台**：基于 MicroPython 的标准库，支持 Raspberry Pi Pico、ESP32 等常见硬件。
* **非阻塞通信**：透传接收接口可循环调用，适合异步框架与事件驱动系统。
* **易调试性**：提供通信检测与参数批量获取功能，简化开发调试流程。

---

## 使用说明

### 安装方法
通过`thonny`工具调试：

**`连接好硬件之后：将code下文件一起上传于根目录，点击运行按钮 `**`

---

## 示例程序
* python

```python
# Python env   : MicroPython v1.23.0
# -*- coding: utf-8 -*-
# @Time    : 2025/9/5 下午10:11
# @Author  : ben0i0d
# @File    : main.py
# @Description : hc14_lora测试文件

# ======================================== 导入相关模块 =========================================

import time
from machine import UART, Pin
from hc14_lora import HC14_Lora

# ======================================== 全局变量 ============================================

# ======================================== 功能函数 ============================================

# ======================================== 自定义类 =============================================

# ======================================== 初始化配置 ===========================================

# 上电延时 3s，给模块稳定时间
time.sleep(3)

# KEY 引脚拉低，进入AT模式
key0 = Pin(2, Pin.OUT)
key0.value(0)

print("FreakStudio: HC14_Lora Test Start")

# 初始化 UART 通信（按硬件实际接线调整 TX/RX）
uart0 = UART(0, baudrate=9600, tx=Pin(0), rx=Pin(1))

# 创建 HC14_Lora 实例
hc0 = HC14_Lora(uart0)

# ======================================== 主程序 ===========================================

# 测试 AT 通信
ok, resp = hc0.test_comm()
if ok:
    print("[OK] AT 通信正常:", resp)
else:
    print("[ERR] AT 通信失败")

# 获取固件版本
ok, resp = hc0.get_version()
if ok:
    print("固件版本:", resp)

# 获取所有关键参数
ok, params = hc0.get_params()
if ok:
    print("当前参数:", params)

key0.value(1)
time.sleep(0.25)

print("进入透传模式，等待接收数据...")

while True:
    ok, resp = hc0.transparent_recv()
    if not ok:
        continue
    else:
        try:
            msg = resp.decode("utf-8")
        except UnicodeError:
            msg = str(resp)
        print("收到:", msg)

        # 回发带前缀的数据
        reply = f"pico:{msg}".encode("utf-8")
        hc0.transparent_send(reply)
        print("发送:", reply)
```
---

## 注意事项

* **供电电压**：HC14 模块工作电压为 **3.3V**，切勿直接接入 5V，否则可能烧毁模块。
* **串口电平**：采用 **3.3V TTL 电平**，如需接入 5V MCU，请添加电平转换。
* **上电延时**：模块上电后需等待 **≥3 秒** 再进入 AT 配置模式，以确保内部稳定。
* **KEY 引脚**：拉低进入 **AT 配置模式**，拉高为 **透传模式**，切换模式后需短暂延时。
* **串口波特率**：默认 **9600 bps**，修改波特率后需同步调整 MCU 端口设置。
* **信道选择**：信道编号范围为 **1–50**，不同节点需保证在相同信道上才能通信。
* **发射功率**：功率范围 **6–20 dBm**，过高会增加功耗，过低会影响通信距离。
* **天线环境**：需保持天线无遮挡，避免金属物体或强电磁干扰影响通信质量。
* **透传模式**：在透传模式下发送的数据不可包含 AT 命令关键字，避免模块误判。
* **配置保存**：修改 AT 参数后需确认是否已保存到模块，否则掉电后会恢复默认值。

---

## 联系方式
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com  
💻 **GitHub**：[https://github.com/FreakStudioCN](https://github.com/FreakStudioCN)  

---

## 许可协议
本项目中，除 `machine` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (MIT)** 许可协议发布。  

您可以自由地：  
- **共享** : 在任何媒介以任何形式复制、发行本作品  
- **演绎** : 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** : 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。您可以用任何合理的方式来署名，但是不得以任何方式暗示许可人为您或您的使用背书。  
- **非商业性使用** :您不得将本作品用于商业目的。  
- **合理引用方式** : 可在代码注释、文档、演示视频或项目说明中明确来源。  
- **声明：** 本项目中所有内容仅可学习或者个人爱好者使用，禁止商用，不得以任何形式以此代码做任何不合理的事情，代码具体可参考这个github项目https://github.com/peterhinch/micropython_ir，发生任何事情与署名作者无关。

- **版权归 FreakStudio 所有。**