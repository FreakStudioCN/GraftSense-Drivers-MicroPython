# 限位开关驱动 - MicroPython版本

## 目录
- [简介](#简介)
- [主要功能](#主要功能)
- [硬件要求](#硬件要求)
- [文件说明](#文件说明)
- [软件设计核心思想](#软件设计核心思想)
- [使用说明](#使用说明)
- [示例程序](#示例程序)
- [注意事项](#注意事项)
- [联系方式](#联系方式)
- [许可协议](#许可协议)

---

## 简介
限位开关（又称行程开关、位置开关）是一种用于检测机械运动极限位置的机电元件，通过物理接触触发通断状态变化，广泛应用于电机行程控制、机械限位保护、自动化设备位置检测等场景。该开关具有结构简单、可靠性高、耐磨损等特点，常见于3D打印机、数控机床、传送带、机器人等设备中。

本项目提供了基于 MicroPython 的驱动代码及示例程序，支持限位开关状态读取、定时器消抖、状态变化回调等核心功能，通过定时器周期性检测与 `micropython.schedule` 确保数据稳定与回调安全，有效避免机械触点抖动导致的误触发，方便开发者快速集成到各类机械控制场景中。

> **注意**：该驱动适用于常开/常闭型数字输出限位开关，默认配置为上拉输入（未触发时输出高电平，触发时输出低电平），实际使用需根据开关类型调整引脚配置。

---

## 主要功能
- **状态检测**：通过 `read()` 方法实时读取开关当前状态（未触发/已触发）
- **消抖优化**：
  - 基于定时器周期性检测（默认 50ms 周期），过滤机械触点抖动
  - 消抖时间可自定义（`debounce_ms` 参数），适应不同开关特性
- **回调机制**：
  - 支持绑定状态变化回调函数，仅在状态稳定变化时触发
  - 回调通过 `micropython.schedule` 调度，安全运行于主线程
- **灵活控制**：
  - `enable()`/`disable()` 方法：启用/禁用消抖检测，按需切换工作模式
  - `set_callback()` 方法：动态修改回调函数，无需重新初始化
- **引脚访问**：通过 `digital` 属性获取底层 GPIO 引脚对象，支持自定义硬件配置（如拉电阻、中断触发）
- **跨平台兼容**：仅依赖 MicroPython 标准库（`machine.Pin`、`machine.Timer`、`micropython`），兼容树莓派 Pico 等主流开发板

---

## 硬件要求
### 推荐测试硬件
- 树莓派 Pico/Pico W
- 限位开关模块（如 SS-5GL2、D4MC-5020 等，支持数字输出）
- 杜邦线若干
- （可选）3.3V 电源模块（若开发板供电不稳定）
- （可选）机械结构（如滑块、挡板，用于触发限位开关）

### 模块引脚说明
| 限位开关引脚 | 功能描述 | 电压要求 | 连接说明 |
|--------------|----------|----------|----------|
| VCC          | 电源正极 | 3.3V-5V（具体取决于开关型号） | 连接开发板 3.3V/5V 引脚（如 Pico 的 Pin36） |
| GND          | 电源负极 | 接地 | 连接开发板 GND 引脚（如 Pico 的 Pin38） |
| OUT          | 数字输出引脚 | 高电平（未触发）/低电平（已触发）（默认上拉配置） | 连接开发板 GPIO 引脚（如 Pico 的 GP19） |

> **说明**：部分限位开关为两线制（仅 COM、NO/NC），需自行搭配上拉/下拉电阻；三线制模块已集成电阻，可直接连接使用，驱动默认适配三线制上拉输出模块。

---

## 文件说明
### limit_switch.py
实现限位开关的核心驱动逻辑，核心类 `LimitSwitch` 封装所有功能接口，支持状态检测、消抖与回调控制。

#### 类定义：`LimitSwitch`
- **`__init__(pin: int, callback: callable = None, debounce_ms: int = 50)`**  
  初始化限位开关：传入 GPIO 引脚编号，配置引脚为上拉输入模式；可选绑定状态变化回调函数；设置消抖时间（默认 50ms）；初始化定时器与上次状态变量。
- **`read() -> bool`**  
  读取当前开关状态：返回 `True` 表示未触发（开关释放），`False` 表示已触发（开关按压），直接读取 GPIO 引脚电平值。
- **`set_callback(callback: callable)`**  
  设置状态变化回调函数：支持动态绑定/修改回调，回调函数会接收一个布尔参数（`True`=未触发，`False`=已触发），仅在状态稳定变化时调用。
- **`enable()`**  
  启用消抖检测：初始化定时器为周期性模式（周期=消抖时间），绑定消抖处理函数 `_debounce_handler`，开始周期性检测状态变化。
- **`disable()`**  
  禁用消抖检测：停止定时器，不再进行周期性状态检测，仅可通过 `read()` 手动读取状态。
- **`_debounce_handler(timer: Timer)`**  
  内部消抖处理函数：定时器触发时读取当前状态，与上次状态对比，若发生变化则更新状态并调度用户回调。
- **`_scheduled_callback(state: int)`**  
  内部调度函数：由 `micropython.schedule` 调用，将引脚电平（0/1）转换为布尔状态后传入用户回调，确保回调安全执行。
- **`digital (property) -> Pin`**  
  属性方法：返回开关绑定的 `Pin` 对象，支持底层硬件配置（如修改拉电阻类型、引脚模式）。

### main.py
限位开关功能测试程序，演示开关初始化、回调绑定、消抖启用、状态循环读取等完整流程，包含键盘中断处理，确保测试安全退出并释放定时器资源。

---

## 软件设计核心思想
### 消抖机制优化
- **定时器周期性检测**：通过固定周期（如 50ms）读取引脚状态，避免机械触点抖动导致的瞬时状态跳变被误判为有效变化，相比中断触发+延时消抖，更节省系统资源且检测更稳定
- **状态对比触发**：仅当当前状态与上次状态不一致时才触发回调，确保回调仅在状态稳定变化时执行，减少无效操作

### 回调安全设计
- **主线程调度**：通过 `micropython.schedule` 将回调从定时器中断上下文调度到主线程执行，避免在中断中执行打印、延时等耗时操作导致系统异常
- **参数标准化**：回调参数统一为布尔类型（`True`=未触发，`False`=已触发），简化开发者使用逻辑，无需关注底层电平值

### 模块化与灵活性
- **功能拆分**：将状态读取、消抖控制、回调管理拆分为独立方法，接口清晰，便于维护与扩展
- **动态配置**：支持初始化后修改回调函数（`set_callback()`）、启用/禁用消抖（`enable()`/`disable()`），适应不同场景下的功能切换需求
- **硬件解耦**：通过 `digital` 属性暴露底层引脚对象，允许开发者根据开关类型（常开/常闭）调整拉电阻配置，提升驱动通用性

---

## 使用说明
### 硬件接线（树莓派 Pico 示例）
| 限位开关引脚 | Pico GPIO 引脚 | 接线功能 |
|--------------|----------------|----------|
| VCC          | 3.3V（Pin36）  | 开关电源输入（三线制模块） |
| GND          | GND（Pin38）   | 电源接地，确保共地避免信号干扰 |
| OUT          | GP19（Pin25）  | 数字信号输入（上拉模式） |

> **注意**：
> 1. 若使用两线制限位开关（无 VCC 引脚），需将开关一端接 GPIO 引脚，另一端接 GND，并通过 `Pin.PULL_UP` 配置上拉电阻（未触发时为高电平，触发时为低电平）
> 2. 若开关为“未触发低电平、触发高电平”（下拉配置），需修改 `__init__` 中引脚初始化代码为 `Pin(pin, Pin.IN, Pin.PULL_DOWN)`

---

### 软件依赖
- **固件版本**：MicroPython v1.23+  
- **内置库**：
  - `machine.Pin`：用于 GPIO 引脚控制
  - `machine.Timer`：用于周期性消抖检测
  - `micropython`：用于安全调度回调函数
  - `time`：用于上电延时与测试循环延时
- **开发工具**：Thonny、PyCharm（带 MicroPython 插件）

---

### 安装步骤
1. **烧录固件**：将 MicroPython v1.23+ 固件烧录到树莓派 Pico
2. **上传文件**：将 `limit_switch.py` 和 `main.py` 上传到 Pico 的文件系统
3. **配置引脚**：根据硬件接线修改 `main.py` 中 `LimitSwitch` 初始化的 `pin` 编号（默认使用 GP19）
4. **运行测试**：在开发工具中执行 `main.py`，通过机械结构触发限位开关，观察状态打印与回调触发信息

---

## 示例程序
```python
# Python env   : MicroPython v1.23.0
# -*- coding: utf-8 -*-
# @Time    : 2025/8/25 上午10:35
# @Author  : 缪贵成
# @File    : main.py
# @Description : 限位开关测试文件

# ======================================== 导入相关模块 =========================================

import time
from limit_switch import LimitSwitch

# ======================================== 全局变量 =============================================

# ======================================== 功能函数 ==============================================

def switch_callback(state: bool):
    """
    用户回调函数，当限位开关状态变化且消抖完成后被调用。

    Args:
        state (bool): True = released（未触发），False = pressed（已触发）

    Notes:
        通过 micropython.schedule 调度执行，安全运行于主线程。
    ==========================================
    User callback function, called after limit switch state change and debounce.

    Args:
        state (bool): True = released (open), False = pressed (closed)

    Notes:
        Scheduled via micropython.schedule, safe in main thread.
    """
    if state:
        print("Limit switch released (open)")
    else:
        print("Limit switch pressed (closed)")

# ======================================== 自定义类 =============================================

# ======================================== 初始化配置 ===========================================

time.sleep(3)
print("FreakStudio: Limit switch test")

# 初始化限位开关，设置消抖时间间隔为 50ms
switch = LimitSwitch(pin=19, callback=switch_callback, debounce_ms=50)
# 启用消抖检测
switch.enable()

# ======================================== 主程序 =============================================

try:
    while True:
        state = switch.read()
        if state:
            print("Current state: released (open)")
        else:
            print("Current state: pressed (closed)")
        time.sleep(1)
except KeyboardInterrupt:
    # 停止测试
    print("Test stopped by user.")
    switch.disable()


```
---
## 注意事项

### 传感器特性限制
- **触发方式**：依赖物理接触触发，需确保机械结构与开关触点对齐，触发行程需满足开关规格（通常 1-5mm）
- **触点寿命**：机械触点存在磨损寿命（通常 10 万 - 100 万次），高频触发场景建议选择无触点式限位开关（如光电式）
- **开关类型适配**：
  - 常开型（NO）：未触发时断开（高电平），触发时闭合（低电平），驱动默认适配
  - 常闭型（NC）：未触发时闭合（低电平），触发时断开（高电平），需修改 `read()` 方法返回值（`return not bool(self._pin.value())`）

---

### 硬件接线与配置注意事项
- **电压匹配**：严格按照开关规格选择供电电压（3.3V/5V），三线制模块需区分 VCC/GND/OUT，接反会导致模块损坏或无输出
- **拉电阻配置**：
  - 两线制开关：必须配置上拉/下拉电阻（驱动默认 `Pin.PULL_UP`），否则引脚电平会悬空，导致状态不稳定
  - 三线制模块：部分已集成拉电阻，需确认模块规格，避免重复配置导致电流过大
- **共地要求**：开关 GND 必须与开发板 GND 可靠连接，否则会出现电平漂移，导致状态检测异常
- **抗干扰布线**：OUT 引脚接线尽量短（建议不超过 30cm），远离电机、继电器等强电磁干扰源；工业场景中建议使用屏蔽线，减少信号干扰

---

### 软件使用建议
- **消抖时间调整**：
  - 机械触点抖动严重的开关：增大 `debounce_ms`（如 100ms），确保状态稳定后再触发回调
  - 高速触发场景：减小 `debounce_ms`（如 20ms），平衡响应速度与消抖效果
- **回调函数设计**：回调函数需简短（避免循环、延时），复杂逻辑（如电机急停、设备报警）建议在回调中设置标志，主线程处理，防止阻塞定时器
- **定时器资源管理**：多个限位开关同时使用时，建议复用定时器（通过定时器回调内遍历检测多个引脚），避免创建过多定时器占用系统资源
- **低功耗优化**：电池供电设备中，非检测时段可调用 `disable()` 关闭定时器，仅在需要检测时调用 `enable()`，降低功耗

---

### 环境影响
- **温度限制**：限位开关最佳工作温度通常为 -20℃~85℃，高温环境（>85℃）会加速触点氧化，低温环境（<-20℃）可能导致塑料部件脆化，影响触发可靠性
- **湿度限制**：高湿环境（>90% RH）可能导致触点锈蚀或短路，建议选择防水型限位开关（如 IP67 防护等级），或增加防潮措施
- **振动影响**：剧烈振动可能导致开关误触发（未接触时触点抖动），安装时需固定牢固，必要时增加缓冲结构（如橡胶垫）减少振动传递

## 联系方式
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com  
💻 **GitHub**：[https://github.com/FreakStudioCN](https://github.com/FreakStudioCN)  

---

## 许可协议
本项目中，除 `machine`、`micropython` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (CC BY-NC 4.0)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。您可以用任何合理的方式来署名，但是不得以任何方式暗示许可人为您或您的使用背书。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。  

**版权归 FreakStudio 所有。**