# PWM 散热风扇驱动 - MicroPython版本

## 目录
- [简介](#简介)
- [主要功能](#主要功能)
- [硬件要求](#硬件要求)
- [文件说明](#文件说明)
- [软件设计核心思想](#软件设计核心思想)
- [使用说明](#使用说明)
- [示例程序](#示例程序)
- [注意事项](#注意事项)
- [联系方式](#联系方式)
- [许可协议](#许可协议)

---

## 简介
PWM 散热风扇是通过脉冲宽度调制（PWM）信号控制转速的冷却设备，广泛应用于电子设备温度控制场景，如 Raspberry Pi Pico 扩展板散热、大功率 LED 驱动模块降温、UV 矩阵散热、工业控制设备冷却等。相比传统“开/关”风扇，PWM 散热风扇可通过调整占空比实现 0~100% 转速精准控制，兼顾散热效率与低功耗需求，同时避免低频运行时的可闻噪音。

本项目提供基于 MicroPython 的 PWM 散热风扇驱动代码及测试程序，支持风扇全速启动、停止、多级转速调节、状态查询等核心功能，针对风扇特性优化 PWM 频率（默认 25kHz，避免噪音），并通过参数校验与错误处理确保驱动稳定性，方便开发者快速集成到温度闭环控制等场景中。

> **注意**：不同品牌 PWM 风扇的“最小启动占空比”不同（通常 10%~30%），低于该值风扇可能无法启动；需确认风扇额定电压与供电匹配，避免硬件损坏。

---

## 主要功能
### 1. 基础转速控制
- **`on()`**：风扇全速运行（占空比 1023，对应 100% 转速），等效于 `set_speed(1023)`
- **`off()`**：风扇停止运行（占空比 0，对应 0% 转速），等效于 `set_speed(0)`
- **`set_speed(duty)`**：自定义转速，占空比范围 0~1023（自动映射为 16 位 PWM 值，适配 MicroPython `duty_u16()` 接口）

### 2. 状态查询与硬件访问
- **`get_speed()`**：返回当前风扇占空比（0~1023），反映实时转速设定值（非硬件反馈值）
- **`digital` 属性**：返回 PWM 控制引脚的 `Pin` 对象，支持底层硬件配置（如引脚模式修改、中断绑定）
- **`pwm` 属性**：返回 PWM 对象，支持高级操作（如动态调整频率、手动停止 PWM 输出）

### 3. 兼容性与安全性优化
- **PWM 频率适配**：默认 25kHz 频率，避免低频（<10kHz）导致的可闻噪音，同时兼容多数 PWM 风扇规格
- **参数校验**：`set_speed()` 自动将占空比限制在 0~1023 范围（超出时自动截断），初始化时支持 PWM 频率合法性检查
- **错误处理**：PWM 初始化失败时抛出 `RuntimeError`，频率超出合理范围时抛出 `ValueError`，便于问题排查
- **跨平台兼容**：仅依赖 MicroPython 标准库（`machine.Pin`、`machine.PWM`），经 Raspberry Pi Pico 验证，兼容多数支持 MicroPython 的开发板

### 4. 易用性设计
- **接口简洁**：核心功能通过 5 个方法/属性实现，无需关注底层 PWM 信号转换（10 位占空比自动转 16 位输出）
- **默认安全配置**：初始化后风扇默认停止（占空比 0），避免上电误启动
- **可扩展性**：支持与温度传感器（如 DS18B20、SHT30）配合，实现“温度-转速”闭环控制（需自行开发温度采集逻辑）

---

## 硬件要求
### 推荐测试硬件
| 硬件组件                | 规格要求                                                                 | 作用说明                                                                 |
|-------------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| Raspberry Pi Pico/Pico W| MicroPython v1.23+ 固件                                                 | 驱动控制核心，输出 PWM 信号                                              |
| PWM 散热风扇            | 额定电压 3.3V/5V、支持 PWM 调速（如 Sunon KDE1204PKV2、Delta AFB0412HHB） | 散热执行器，通过 PWM 信号调整转速                                        |
| 电源模块                | 输出电压与风扇额定电压一致（如 5V/1A 电源）                              | 为风扇提供功率供电（Pico GPIO 仅输出控制信号，不提供大功率供电）          ||

### 硬件接线方案（Raspberry Pi Pico 示例）
| 风扇引脚       | 连接对象               | 中间元件                | 作用说明                                                                 |
|----------------|--------------------|-------------------------|--------------------------------------------------------------------------|
| PWM 控制端（PWM）| Pico GPIO 6（示例）    | 1kΩ 限流电阻            | 接收 Pico 输出的 PWM 信号，控制风扇转速                                  |
| 电源正极（VCC） | 5V 电源正极            | （可选）10Ω/1W 限流电阻 | 为风扇提供功率供电（需与风扇额定电压一致）                                |
| 电源负极（GND） | 5V 电源负极 + Pico GND | 无                      | 共地，确保 PWM 信号电平稳定（必须可靠连接，否则风扇可能误动作）            |
| （可选）转速反馈（FG）| Pico GPIO（如 GP16）  | 无                      | 风扇转速硬件反馈（本驱动暂不支持读取，需自行扩展中断处理逻辑）             |

> **关键提醒**：  
> 1. Pico GPIO 仅输出 PWM 控制信号，**不可直接为风扇供电**（GPIO 最大输出电流 ~16mA，远低于风扇额定电流）；  
> 2. MOS 管驱动时，需确保风扇电源、Pico、MOS 管共地，否则 PWM 信号会因电平漂移导致控制失效。

---

## 文件说明
### 1. fan_pwm.py（核心驱动文件）
实现 PWM 散热风扇的驱动逻辑，核心类 `FanPWM` 封装所有功能接口，关键代码解析如下：

| 类方法/属性               | 功能描述                                                                 | 关键实现细节                                                                 |
|---------------------------|--------------------------------------------------------------------------|------------------------------------------------------------------------------|
| `__init__(pin, pwm_freq)` | 初始化 PWM 引脚与频率                                                   | 1. 配置 GPIO 为输出模式，创建 PWM 对象；<br>2. 默认频率 25kHz，占空比 0（风扇停止）；<br>3. 频率超出合理范围时抛出 `ValueError` |
| `set_speed(duty)`         | 设定风扇占空比（0~1023）                                                | 1. 自动截断超出范围的占空比（`max(0, min(1023, duty))`）；<br>2. 将 10 位占空比映射为 16 位值（`duty/1023 * 65535`），调用 `duty_u16()` 输出 |
| `get_speed()`             | 返回当前占空比                                                           | 读取软件缓存的 `_duty` 值（非硬件寄存器，避免频繁访问硬件）                   |
| `digital`（属性）         | 返回 PWM 控制引脚的 `Pin` 对象                                          | 支持开发者自定义引脚操作（如绑定中断检测风扇反馈信号）                       |
| `pwm`（属性）             | 返回 PWM 对象                                                            | 支持动态调整频率（如 `fan.pwm.freq(30000)`）、停止 PWM（`fan.pwm.deinit()`） |

### 2. main.py（测试程序）
演示 `FanPWM` 类的完整使用流程，包括：
1. 上电延时 3 秒（确保硬件稳定）；
2. 初始化风扇（默认引脚 GP15，频率 25kHz）；
3. 分步测试：全速启动 → 停止 → 256/512/768/1023 占空比切换；
4. 硬件对象访问测试（读取 `digital` 和 `pwm` 属性）；
5. 键盘中断（Ctrl+C）捕获，确保程序退出时风扇停止。

---

## 软件设计核心思想
### 1. 转速控制逻辑优化
- **占空比映射**：考虑到 MicroPython 多数开发板（如 Pico）的 PWM 接口采用 16 位精度（`duty_u16()`），驱动内部自动将用户友好的 10 位占空比（0~1023）转换为 16 位值（`duty * 65535 // 1023`），简化调用逻辑；
- **最小启动占空比兼容**：通过 `set_speed()` 支持 0~1023 全范围设定，开发者可根据风扇规格调整启动阈值（如 `if duty < 50: duty = 50`，确保风扇启动）。

### 2. 噪音与兼容性平衡
- **默认频率选择**：调研主流 PWM 风扇规格后，选择 25kHz 作为默认频率——该频率高于人耳可闻范围（20Hz~20kHz），避免低频噪音，同时兼容多数风扇的 PWM 响应频率（通常 1kHz~50kHz）；
- **频率可配置**：通过 `__init__` 的 `pwm_freq` 参数支持自定义频率（如高转速风扇可提高至 30kHz，降低电磁干扰）。

### 3. 安全性与可维护性
- **参数校验**：`set_speed()` 自动处理超出范围的占空比（如传入 1200 时自动截断为 1023），避免无效值导致硬件异常；
- **资源管理**：程序退出时通过 `finally` 块调用 `off()`，确保风扇停止，避免无人值守时的能源浪费；
- **接口解耦**：核心功能与硬件操作分离（如 `digital`/`pwm` 属性暴露底层对象），支持开发者扩展功能（如添加风扇转速反馈中断）。

---

## 使用说明
### 1. 硬件接线步骤（以 Pico + 5V PWM 风扇为例）
1. **供电线路连接**：  
   - 5V 电源正极 → 风扇 VCC 引脚（如需过流保护，串联 10Ω/1W 电阻）；  
   - 5V 电源负极 → 风扇 GND 引脚 + Pico GND 引脚（必须共地，否则 PWM 信号失效）。
2. **控制线路连接**：  
   - Pico GP15 引脚 → 1kΩ 限流电阻 → 风扇 PWM 控制引脚；  
   - 确认所有接线无松动，尤其 GND 线路需可靠连接。

### 2. 软件部署与测试
1. **固件准备**：为 Raspberry Pi Pico 烧录 MicroPython v1.23+ 固件（参考 [MicroPython 官方文档](https://datasheets.raspberrypi.com/pico/getting-started-with-micropython.pdf)）；
2. **文件上传**：通过 Thonny 或 PyCharm（MicroPython 插件）将 `fan_pwm.py` 和 `main.py` 上传到 Pico 文件系统；
3. **参数配置**：根据实际接线修改 `main.py` 中 `FanPWM(pin=15)` 的 `pin` 参数（如使用 GP16 则改为 `pin=16`）；
4. **运行测试**：执行 `main.py`，观察风扇状态——应依次完成“全速转动 5 秒 → 停止 5 秒 → 256/512/768/1023 占空比切换（每级 5 秒）”。
---
## 示例程序
* python
```python
# Python env   : MicroPython v1.23.0
# -*- coding: utf-8 -*-
# @Time    : 2025/8/28 上午11:22
# @Author  : 缪贵成
# @File    : main.py
# @Description : pwm驱动散热风扇驱动测试文件 测试了不同的占空比


# ======================================== 导入相关模块 =========================================

# 导入时间相关模块
import time
# 导入风扇驱动模块
from fan_pwm import FanPWM

# ======================================== 全局变量 ============================================

# ======================================== 功能函数 ============================================

# ======================================== 自定义类 ============================================

# ======================================== 初始化配置 ===========================================

# 上电延时3s
time.sleep(3)
print("FreakStudio:Testing PWM cooling fans")

# 创建一个 FANPWM 对象
fan = FanPWM(pin=6)

# ========================================  主程序  ============================================

try:
    print("\n[Step 1] Turning fan ON (full speed)...")
    fan.on()
    print(f"Current duty: {fan.get_speed()}")
    time.sleep(5)

    print("\n[Step 2] Turning fan OFF...")
    fan.off()
    print(f"Current duty: {fan.get_speed()}")
    time.sleep(5)

    # 测试不同占空比
    for duty in [256, 512, 768, 1023]:
        print(f"\n[Step] Setting fan duty to {duty}...")
        fan.set_speed(duty)
        print(f"Current duty: {fan.get_speed()}")
        time.sleep(5)

    print("\n[Step 3] Testing digital property (Pin object)...")
    pin_obj = fan.digital
    print(f"Pin object: {pin_obj}")
    time.sleep(5)

    print("\n[Step 4] Testing pwm property (PWM object)...")
    pwm_obj = fan.pwm
    print(f"PWM object: {pwm_obj}")
    time.sleep(5)

except KeyboardInterrupt:
    print("\nTest interrupted by user.")

finally:
    print("\n[Cleanup] Turning fan OFF...")
    fan.off()
    print("Test complete.")

```
---
## 注意事项

### 1. 硬件安全限制
#### （1）供电匹配：避免电压/电流不兼容
- **电压要求**：风扇额定电压必须与电源一致（如 5V 风扇接 5V 电源，3.3V 风扇接 3.3V 电源），电压过高会烧毁风扇线圈，过低会导致转速不足或无法启动；
- **电流承载**：风扇供电线路需使用足够粗的导线（如 24AWG），避免线路压降导致风扇转速波动；若风扇额定电流 > 0.5A，需选用散热更好的 MOS 管（如 IRFZ44N）；
- **GPIO 保护**：PWM 控制线路必须串联 1kΩ 限流电阻，防止风扇 PWM 端反向漏电烧毁 Pico GPIO 引脚。

#### （2）启动占空比：确保风扇正常启动
- 多数 PWM 风扇存在 “最小启动占空比”（如 20%，对应 `duty=205`），低于该值风扇可能无法启动（表现为 “嗡嗡响但不转”）；
- 测试方法：从 `duty=300` 开始逐步降低，记录最小启动占空比，在实际应用中避免低于该值的设定。

### 2. 环境影响与维护
#### （1）温度与湿度
- 风扇工作温度范围通常为 **-10℃~60℃**，避免在高温（>60℃）环境下长时间运行——高温会加速风扇内部轴承老化，缩短使用寿命，严重时可能导致轴承卡死、线圈烧毁；
- 高湿环境（相对湿度 >85% RH）需为风扇添加防水罩或防护外壳，防止空气中的水汽进入风扇内部，导致线圈锈蚀、触点氧化，影响电机正常运转。

#### （2）灰尘清理
- 风扇长期运行会从进风口吸入灰尘，积累在叶片、轴承及线圈表面，导致：① 叶片重量不平衡，转速下降且噪音增大；② 轴承润滑脂混合灰尘后摩擦阻力增加，进一步降低转速；
- 建议每 **3 个月** 进行一次灰尘清理：使用压缩气罐（气压 ≤0.3MPa）从进风口向出风口方向吹气，清除叶片与外壳缝隙的灰尘；**严禁拆解风扇**（多数 PWM 风扇为密封轴承设计，拆解会破坏密封结构，导致润滑脂泄漏）。


### 3. 常见问题排查
| 问题现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 风扇不转，无任何反应 | 1. 供电线路断开（如 VCC/GND 接线松动）；<br>2. PWM 控制线路虚接（如引脚接触不良）；<br>3. 占空比低于风扇最小启动值 | 1. 用万用表检测风扇 VCC 与 GND 之间电压，确认供电正常且共地可靠；<br>2. 重新插拔 PWM 控制线路，或更换杜邦线排除接触问题；<br>3. 将占空比提高至 300+（约 30% 转速），测试风扇是否启动 |
| 风扇嗡嗡响但不转 | 1. 占空比接近最小启动值，但未达到阈值；<br>2. 轴承长期未清理或老化，出现卡顿；<br>3. 供电电压低于风扇额定值（如 5V 风扇接 4.5V 电源） | 1. 将占空比提高至 400+（约 40% 转速），观察是否正常转动；<br>2. 断电后手动轻转风扇叶片，若有明显阻力，需用压缩气罐清理轴承附近灰尘（严重卡顿需更换风扇）；<br>3. 更换与风扇额定电压匹配的电源（如 5V/1A 电源） |
| 转速不稳定，忽快忽慢 | 1. 供电电压波动（如电源适配器功率不足、导线压降过大）；<br>2. PWM 控制线路靠近电机、继电器等强电磁干扰源，信号失真；<br>3. 风扇老化（轴承磨损、线圈阻抗变化） | 1. 用万用表监测风扇供电电压，更换稳压电源或加粗供电导线（如 24AWG 换 22AWG）；<br>2. 重新布线，使 PWM 控制线路远离干扰源，或在线路外层包裹屏蔽层（如铝箔纸）；<br>3. 更换新风扇，对比测试转速稳定性 |
| 程序报错 “RuntimeError: PWM init failed” | 1. 目标 GPIO 引脚已被其他设备占用（如已初始化作为 UART _TX 或其他 PWM 设备）；<br>2. 选择的引脚不支持 PWM 功能（如部分开发板的 GPIO0 仅支持数字输入/输出） | 1. 检查代码中是否有其他模块占用该引脚，停止相关设备释放资源；<br>2. 参考开发板引脚图，更换支持 PWM 功能的引脚（如 Raspberry Pi Pico 的 GP0~GP28 中带 “PWM” 标记的引脚） |

---
## 联系方式
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com  
💻 **GitHub**：[https://github.com/FreakStudioCN](https://github.com/FreakStudioCN)  
---

## 许可协议
本项目中，除 `machine` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (MIT)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。您可以用任何合理的方式来署名，但是不得以任何方式暗示许可人为您或您的使用背书。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。  

**版权归 FreakStudio 所有。**
